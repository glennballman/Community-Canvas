name: QA + SCM Certification

on:
  push:
    branches: ["main"]
  pull_request:

concurrency:
  group: qa-scm-${{ github.ref }}
  cancel-in-progress: true

jobs:
  qa_scm_p2_operator:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install deps
        run: npm ci

      - name: Set build timestamp
        if: always()
        run: echo "BUILD_TS=$(date -u +'%Y%m%dT%H%M%SZ')" >> $GITHUB_ENV

      # Start server if your QA scripts hit localhost.
      # If you instead hit a deployed environment via QA_BASE_URL, remove this step.
      - name: Start server (background)
        run: |
          nohup npm run dev > server.log 2>&1 &
          echo "Server starting..."
          sleep 5

      - name: Guardrails - Pricing UI lint
        run: npx tsx scripts/lint-pricing-ui.ts

      - name: Run P2 operator smoke test
        env:
          QA_BASE_URL: http://localhost:3000
          QA_JWT: ${{ secrets.QA_JWT }}
          QA_COOKIE: ${{ secrets.QA_COOKIE }}
          QA_CLAIM_ID: ${{ secrets.QA_CLAIM_ID }}
          QA_DISPUTE_ID: ${{ secrets.QA_DISPUTE_ID }}
          QA_GRANTEE_INDIVIDUAL_ID: ${{ secrets.QA_GRANTEE_INDIVIDUAL_ID }}
        run: npx tsx scripts/qa/qa-operator-p2-smoke.ts

      - name: Run SCM ingest
        run: npx tsx scripts/qa/scm-ingest-p2-operator.ts

      - name: SCM Certification Summary
        if: always()
        run: |
          CERT_PATH="artifacts/qa/scm/p2-operator-cert.json"

          if [ ! -f "$CERT_PATH" ]; then
            echo "### âŒ SCM Certification" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Certification file not found." >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

          OVERALL=$(node -e "const c=require('./$CERT_PATH'); console.log(c.summary.overall_status)")
          PASS=$(node -e "const c=require('./$CERT_PATH'); console.log(c.summary.pass_modules)")
          HELD=$(node -e "const c=require('./$CERT_PATH'); console.log(c.summary.held_modules)")
          FAIL=$(node -e "const c=require('./$CERT_PATH'); console.log(c.summary.fail_modules)")
          SHA=$(node -e "const c=require('./$CERT_PATH'); console.log(c.input.proof_sha256)")

          echo "### ðŸ§¾ SCM Certification Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Overall Status:** \`$OVERALL\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| PASS modules | $PASS |" >> $GITHUB_STEP_SUMMARY
          echo "| HELD modules | $HELD |" >> $GITHUB_STEP_SUMMARY
          echo "| FAIL modules | $FAIL |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Proof SHA256:** \`$SHA\`" >> $GITHUB_STEP_SUMMARY

          if [ "$OVERALL" = "PASS" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… All required modules certified." >> $GITHUB_STEP_SUMMARY
          elif [ "$OVERALL" = "HELD" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ Certification HELD â€” optional modules incomplete or authority proof incomplete." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âŒ Certification FAILED â€” required module proof missing or failed." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Badge: artifacts/qa/scm/p2-operator-cert-badge.svg (uploaded as build artifact)" >> $GITHUB_STEP_SUMMARY

      - name: Generate SCM badge
        if: always()
        run: npx tsx scripts/qa/scm-badge.ts

      - name: Upload QA + SCM artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: qa-scm-${{ github.sha }}-${{ env.BUILD_TS }}
          path: |
            artifacts/qa/**
            server.log
          if-no-files-found: warn
          retention-days: 14
