PROMPT 4 (FIXED) â€” Parking Plan View
Paste this complete, corrected prompt into Replit:
## UI PROMPT 4 â€” Parking Plan View (CORRECTED)

### CONTEXT
- Tenant App UI PROMPTs 1-3, 6-8 âœ… complete
- B1 Spatial Patch COMPLETE:
  - `cc_units` has: `layout_x`, `layout_y`, `layout_rotation`, `layout_shape`, `layout_bounds`, `layout_ref`
  - `cc_reservation_allocations` has: `starts_at`, `ends_at`, `unit_id`
  - `cc_parking_unit_details` table exists
- Availability queries use `starts_at/ends_at` overlap logic

### GOAL
Implement Parking Plan View at:
- `/app/parking/plan`

This is an **operations map** for parking staff to:
- See visual layout of parking stalls
- View real-time occupancy status
- Click a stall for details/actions
- Filter by zone, status, date

### NON-NEGOTIABLE RULES
- No currency display (even though `*_rate_cad` columns exist)
- Use "reservation" not "booking"
- P2 envelope `{ ok, error?, ...data }`
- Must show: loading, empty, error states
- Graceful degradation if no layout data exists
- Stable selectors for QA (per-unit)
- Tenant scoping required on all queries

---

## 1) PAGE LAYOUT
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Parking Plan                    [Date Picker] [Filters â–¾]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                 â”‚  â”‚  STALL DETAILS   â”‚  â”‚
â”‚  â”‚      PLAN VIEW / GRID           â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚  Stall: A-01     â”‚  â”‚
â”‚  â”‚   [A-01] [A-02] [A-03] [A-04]   â”‚  â”‚  Zone: A         â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚  Status: Occupiedâ”‚  â”‚
â”‚  â”‚   [A-05] [A-06] [A-07] [A-08]   â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚  Current:        â”‚  â”‚
â”‚  â”‚   [B-01] [B-02] [B-03] [B-04]   â”‚  â”‚  John Smith      â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚  Jan 15-18       â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚  Plate: ABC-123  â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚                  â”‚  â”‚
â”‚  â”‚                                 â”‚  â”‚  [View Res.]     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                             â”‚
â”‚  Legend: ğŸŸ¢ Available  ğŸ”´ Occupied  ğŸŸ¡ Reserved  âš« Maint.  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

---

## 2) FILES TO CREATE

### Frontend
client/src/pages/app/ParkingPlanPage.tsx
client/src/components/parking/ParkingPlanView.tsx
client/src/components/parking/ParkingStall.tsx
client/src/components/parking/ParkingDetailPanel.tsx
client/src/components/parking/ParkingFilters.tsx
client/src/components/parking/ParkingLegend.tsx
client/src/hooks/useParkingUnits.ts
client/src/hooks/useParkingAvailability.ts

### Backend
server/routes/p2-parking.ts

---

## 3) DATA CONTRACT

### GET /api/p2/parking/units

Query params:
- `propertyId` (required)
- `zoneCode` (optional filter)

Response:
```typescript
{
  ok: true,
  units: Array<{
    id: string,
    code: string,
    name: string,
    unit_type: "parking_stall",
    layout_x: number | null,
    layout_y: number | null,
    layout_rotation: number | null,
    layout_shape: object | null,
    layout_ref: string | null,
    zone_code: string | null,
    size_class: string | null,
    covered: boolean,
    accessible: boolean,
    ev_charging: boolean,
    status: "available" | "maintenance" | "blocked"
  }>,
  property: { id: string, name: string }
}
```

### GET /api/p2/parking/availability

Query params:
- `propertyId` (required)
- `date` (required, defaults to today)

Response:
```typescript
{
  ok: true,
  date: string,
  allocations: Array<{
    unit_id: string,
    unit_code: string,
    status: "available" | "occupied" | "reserved" | "maintenance",
    allocation_id: string | null,
    guest_name: string | null,
    vehicle_plate: string | null,
    starts_at: string | null,
    ends_at: string | null,
    reservation_id: string | null
  }>
}
```

---

## 4) FRONTEND COMPONENTS

### useParkingUnits.ts
```typescript
// client/src/hooks/useParkingUnits.ts

import { useQuery } from "@tanstack/react-query";

interface ParkingUnit {
  id: string;
  code: string;
  name: string;
  unit_type: string;
  status: string;
  layout_x: number | null;
  layout_y: number | null;
  layout_rotation: number | null;
  layout_shape: object | null;
  layout_ref: string | null;
  zone_code: string | null;
  size_class: string | null;
  covered: boolean;
  accessible: boolean;
  ev_charging: boolean;
}

interface ParkingUnitsResponse {
  units: ParkingUnit[];
  property: { id: string; name: string } | null;
}

export function useParkingUnits(propertyId: string | null, zoneCode?: string) {
  return useQuery({
    queryKey: ["parking-units", propertyId, zoneCode],
    queryFn: async (): Promise<ParkingUnitsResponse> => {
      const params = new URLSearchParams();
      if (propertyId) params.set("propertyId", propertyId);
      if (zoneCode && zoneCode !== "all") params.set("zoneCode", zoneCode);

      const res = await fetch(`/api/p2/parking/units?${params}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error?.message || "Failed to fetch units");
      return data;
    },
    enabled: !!propertyId,
  });
}
```

### useParkingAvailability.ts
```typescript
// client/src/hooks/useParkingAvailability.ts

import { useQuery } from "@tanstack/react-query";

interface ParkingAllocation {
  unit_id: string;
  unit_code: string;
  status: "available" | "occupied" | "reserved" | "maintenance";
  allocation_id: string | null;
  guest_name: string | null;
  vehicle_plate: string | null;
  starts_at: string | null;
  ends_at: string | null;
  reservation_id: string | null;
}

interface ParkingAvailabilityResponse {
  date: string;
  allocations: ParkingAllocation[];
}

export function useParkingAvailability(propertyId: string | null, date: Date) {
  const dateStr = date.toISOString().split("T")[0];

  return useQuery({
    queryKey: ["parking-availability", propertyId, dateStr],
    queryFn: async (): Promise<ParkingAvailabilityResponse> => {
      const params = new URLSearchParams();
      if (propertyId) params.set("propertyId", propertyId);
      params.set("date", dateStr);

      const res = await fetch(`/api/p2/parking/availability?${params}`);
      const data = await res.json();
      if (!data.ok) throw new Error(data.error?.message || "Failed to fetch availability");
      return data;
    },
    enabled: !!propertyId,
    refetchInterval: 60000, // Refresh every minute
  });
}
```

### ParkingPlanPage.tsx
```typescript
// client/src/pages/app/ParkingPlanPage.tsx

import { useState, useMemo } from "react";
import { format } from "date-fns";
import { ChevronLeft, ChevronRight } from "lucide-react";
import { useParkingUnits } from "@/hooks/useParkingUnits";
import { useParkingAvailability } from "@/hooks/useParkingAvailability";
import { ParkingPlanView } from "@/components/parking/ParkingPlanView";
import { ParkingDetailPanel } from "@/components/parking/ParkingDetailPanel";
import { ParkingFilters } from "@/components/parking/ParkingFilters";
import { ParkingLegend } from "@/components/parking/ParkingLegend";

// TODO: Get propertyId from route params or context
const DEFAULT_PROPERTY_ID = null; // Set this or get from URL/context

export default function ParkingPlanPage() {
  const [propertyId, setPropertyId] = useState<string | null>(DEFAULT_PROPERTY_ID);
  const [selectedDate, setSelectedDate] = useState(new Date());
  const [selectedUnitId, setSelectedUnitId] = useState<string | null>(null);
  const [filters, setFilters] = useState({ zoneCode: "all", status: "all" });
  const [viewMode, setViewMode] = useState<"grid" | "layout">("grid");

  const { data: unitsData, isLoading: unitsLoading, error: unitsError } = useParkingUnits(propertyId, filters.zoneCode);
  const { data: availData, isLoading: availLoading } = useParkingAvailability(propertyId, selectedDate);

  // Merge units with availability status
  const unitsWithStatus = useMemo(() => {
    if (!unitsData?.units) return [];

    const allocMap = new Map(
      (availData?.allocations || []).map((a) => [a.unit_id, a])
    );

    return unitsData.units
      .map((unit) => {
        const alloc = allocMap.get(unit.id);
        return {
          ...unit,
          currentStatus: alloc?.status || (unit.status === "maintenance" ? "maintenance" : "available"),
          allocation: alloc || null,
        };
      })
      .filter((unit) => {
        if (filters.status === "all") return true;
        return unit.currentStatus === filters.status;
      });
  }, [unitsData, availData, filters.status]);

  const selectedUnit = useMemo(() => {
    return unitsWithStatus.find((u) => u.id === selectedUnitId) || null;
  }, [unitsWithStatus, selectedUnitId]);

  // Get unique zones for filter
  const zones = useMemo(() => {
    if (!unitsData?.units) return [];
    const zoneSet = new Set(unitsData.units.map((u) => u.zone_code).filter(Boolean));
    return Array.from(zoneSet).sort();
  }, [unitsData]);

  const navigateDate = (days: number) => {
    const newDate = new Date(selectedDate);
    newDate.setDate(newDate.getDate() + days);
    setSelectedDate(newDate);
  };

  // Loading state
  if (unitsLoading && !unitsData) {
    return (
      <div className="p-6" data-testid="parking-plan">
        <div className="animate-pulse space-y-4">
          <div className="h-8 bg-gray-200 rounded w-48"></div>
          <div className="h-64 bg-gray-200 rounded"></div>
        </div>
      </div>
    );
  }

  // Error state
  if (unitsError) {
    return (
      <div className="p-6" data-testid="parking-plan">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4">
          <h3 className="text-red-800 font-medium">Unable to load parking plan</h3>
          <p className="text-red-600 text-sm mt-1">{(unitsError as Error).message}</p>
        </div>
      </div>
    );
  }

  // No property selected
  if (!propertyId) {
    return (
      <div className="p-6" data-testid="parking-plan">
        <div className="bg-gray-50 border border-gray-200 rounded-lg p-8 text-center">
          <p className="text-gray-500">Select a property to view parking plan</p>
          {/* TODO: Add property selector */}
        </div>
      </div>
    );
  }

  return (
    <div className="p-6 space-y-6" data-testid="parking-plan">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Parking Plan</h1>
          <p className="text-sm text-gray-500 mt-1">
            {unitsData?.property?.name || "Property"} Â· {unitsWithStatus.length} stalls
          </p>
        </div>

        {/* Date Navigation */}
        <div className="flex items-center gap-2">
          <button
            onClick={() => navigateDate(-1)}
            className="p-2 hover:bg-gray-100 rounded"
          >
            <ChevronLeft className="h-5 w-5" />
          </button>
          <div className="px-4 py-2 bg-white border border-gray-200 rounded-lg min-w-[160px] text-center">
            <input
              type="date"
              value={format(selectedDate, "yyyy-MM-dd")}
              onChange={(e) => setSelectedDate(new Date(e.target.value))}
              className="bg-transparent border-none text-center cursor-pointer"
            />
          </div>
          <button
            onClick={() => navigateDate(1)}
            className="p-2 hover:bg-gray-100 rounded"
          >
            <ChevronRight className="h-5 w-5" />
          </button>
          <button
            onClick={() => setSelectedDate(new Date())}
            className="px-3 py-2 text-sm text-blue-600 hover:bg-blue-50 rounded"
          >
            Today
          </button>
        </div>
      </div>

      {/* Filters */}
      <ParkingFilters
        zones={zones}
        filters={filters}
        onChange={setFilters}
        viewMode={viewMode}
        onViewModeChange={setViewMode}
      />

      {/* Main Content */}
      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* Plan View */}
        <div className="lg:col-span-2">
          {unitsWithStatus.length === 0 ? (
            <div className="bg-gray-50 border border-gray-200 rounded-lg p-12 text-center">
              <p className="text-gray-500">No parking stalls found</p>
              {filters.zoneCode !== "all" || filters.status !== "all" ? (
                <button
                  onClick={() => setFilters({ zoneCode: "all", status: "all" })}
                  className="mt-2 text-sm text-blue-600 hover:underline"
                >
                  Clear filters
                </button>
              ) : null}
            </div>
          ) : (
            <ParkingPlanView
              units={unitsWithStatus}
              selectedId={selectedUnitId}
              onSelect={setSelectedUnitId}
              viewMode={viewMode}
              isLoading={availLoading}
            />
          )}
        </div>

        {/* Detail Panel */}
        <div className="lg:col-span-1">
          <ParkingDetailPanel
            unit={selectedUnit}
            onClose={() => setSelectedUnitId(null)}
          />
        </div>
      </div>

      {/* Legend */}
      <ParkingLegend />
    </div>
  );
}
```

### ParkingPlanView.tsx
```typescript
// client/src/components/parking/ParkingPlanView.tsx

import { useMemo } from "react";
import { ParkingStall } from "./ParkingStall";

interface ParkingUnit {
  id: string;
  code: string;
  layout_x: number | null;
  layout_y: number | null;
  layout_rotation: number | null;
  zone_code: string | null;
  accessible: boolean;
  currentStatus: string;
  allocation: any;
}

interface Props {
  units: ParkingUnit[];
  selectedId: string | null;
  onSelect: (id: string) => void;
  viewMode: "grid" | "layout";
  isLoading?: boolean;
}

export function ParkingPlanView({ units, selectedId, onSelect, viewMode, isLoading }: Props) {
  const hasLayoutData = units.some((u) => u.layout_x !== null && u.layout_y !== null);

  if (viewMode === "layout" && hasLayoutData) {
    return (
      <PositionedLayout
        units={units}
        selectedId={selectedId}
        onSelect={onSelect}
        isLoading={isLoading}
      />
    );
  }

  return (
    <GridLayout
      units={units}
      selectedId={selectedId}
      onSelect={onSelect}
      isLoading={isLoading}
    />
  );
}

function GridLayout({
  units,
  selectedId,
  onSelect,
  isLoading,
}: Omit<Props, "viewMode">) {
  // Group by zone_code
  const byZone = useMemo(() => {
    const groups: Record<string, ParkingUnit[]> = {};
    for (const unit of units) {
      const zone = unit.zone_code || "Unassigned";
      if (!groups[zone]) groups[zone] = [];
      groups[zone].push(unit);
    }
    // Sort zones alphabetically
    return Object.entries(groups).sort(([a], [b]) => a.localeCompare(b));
  }, [units]);

  return (
    <div className={`space-y-6 ${isLoading ? "opacity-60" : ""}`}>
      {byZone.map(([zone, zoneUnits]) => (
        <div key={zone} className="bg-white border border-gray-200 rounded-lg p-4">
          <h3 className="text-sm font-medium text-gray-700 mb-3">Zone {zone}</h3>
          <div className="grid grid-cols-6 sm:grid-cols-8 md:grid-cols-10 gap-2">
            {zoneUnits.map((unit) => (
              <ParkingStall
                key={unit.id}
                unit={unit}
                isSelected={unit.id === selectedId}
                onClick={() => onSelect(unit.id)}
              />
            ))}
          </div>
        </div>
      ))}
    </div>
  );
}

function PositionedLayout({
  units,
  selectedId,
  onSelect,
  isLoading,
}: Omit<Props, "viewMode">) {
  const bounds = useMemo(() => {
    const xs = units.map((u) => u.layout_x || 0);
    const ys = units.map((u) => u.layout_y || 0);
    return {
      minX: Math.min(...xs),
      maxX: Math.max(...xs),
      minY: Math.min(...ys),
      maxY: Math.max(...ys),
    };
  }, [units]);

  const rangeX = bounds.maxX - bounds.minX || 1;
  const rangeY = bounds.maxY - bounds.minY || 1;

  return (
    <div
      className={`relative w-full h-[500px] bg-gray-100 border border-gray-200 rounded-lg overflow-hidden ${
        isLoading ? "opacity-60" : ""
      }`}
    >
      {units.map((unit) => {
        const left = ((unit.layout_x || 0) - bounds.minX) / rangeX * 85 + 5;
        const top = ((unit.layout_y || 0) - bounds.minY) / rangeY * 85 + 5;

        return (
          <div
            key={unit.id}
            style={{
              position: "absolute",
              left: `${left}%`,
              top: `${top}%`,
              transform: `rotate(${unit.layout_rotation || 0}deg)`,
            }}
          >
            <ParkingStall
              unit={unit}
              isSelected={unit.id === selectedId}
              onClick={() => onSelect(unit.id)}
            />
          </div>
        );
      })}
    </div>
  );
}
```

### ParkingStall.tsx
```typescript
// client/src/components/parking/ParkingStall.tsx

interface ParkingUnit {
  id: string;
  code: string;
  accessible: boolean;
  currentStatus: string;
}

interface Props {
  unit: ParkingUnit;
  isSelected: boolean;
  onClick: () => void;
}

const statusColors: Record<string, string> = {
  available: "bg-green-500 hover:bg-green-600",
  occupied: "bg-red-500 hover:bg-red-600",
  reserved: "bg-yellow-500 hover:bg-yellow-600",
  maintenance: "bg-gray-400 hover:bg-gray-500",
};

export function ParkingStall({ unit, isSelected, onClick }: Props) {
  const colorClass = statusColors[unit.currentStatus] || statusColors.available;

  return (
    <button
      onClick={onClick}
      data-testid={`parking-stall-${unit.id}`}
      className={`
        w-12 h-8 rounded text-xs font-medium text-white
        flex items-center justify-center
        transition-all cursor-pointer
        ${colorClass}
        ${isSelected ? "ring-2 ring-blue-600 ring-offset-2" : ""}
        ${unit.accessible ? "border-2 border-blue-300" : ""}
      `}
      title={`${unit.code} - ${unit.currentStatus}`}
    >
      {unit.code}
    </button>
  );
}
```

### ParkingDetailPanel.tsx
```typescript
// client/src/components/parking/ParkingDetailPanel.tsx

import { format } from "date-fns";
import { X, Car, Accessibility, Zap, Home } from "lucide-react";
import { Link } from "wouter";

interface Props {
  unit: {
    id: string;
    code: string;
    name: string;
    zone_code: string | null;
    size_class: string | null;
    covered: boolean;
    accessible: boolean;
    ev_charging: boolean;
    currentStatus: string;
    allocation: {
      guest_name: string | null;
      vehicle_plate: string | null;
      starts_at: string | null;
      ends_at: string | null;
      reservation_id: string | null;
    } | null;
  } | null;
  onClose: () => void;
}

const statusLabels: Record<string, { label: string; className: string }> = {
  available: { label: "Available", className: "bg-green-100 text-green-800" },
  occupied: { label: "Occupied", className: "bg-red-100 text-red-800" },
  reserved: { label: "Reserved", className: "bg-yellow-100 text-yellow-800" },
  maintenance: { label: "Maintenance", className: "bg-gray-100 text-gray-800" },
};

export function ParkingDetailPanel({ unit, onClose }: Props) {
  if (!unit) {
    return (
      <div
        className="bg-white border border-gray-200 rounded-lg p-6 text-center text-gray-500"
        data-testid="parking-detail-panel"
      >
        <Car className="h-12 w-12 mx-auto mb-3 text-gray-300" />
        <p>Select a stall to view details</p>
      </div>
    );
  }

  const statusConfig = statusLabels[unit.currentStatus] || statusLabels.available;

  return (
    <div
      className="bg-white border border-gray-200 rounded-lg p-6 space-y-4"
      data-testid="parking-detail-panel"
    >
      {/* Header */}
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold text-gray-900">Stall {unit.code}</h3>
        <button
          onClick={onClose}
          className="text-gray-400 hover:text-gray-600 p-1"
        >
          <X className="h-5 w-5" />
        </button>
      </div>

      {/* Status Badge */}
      <div>
        <span className={`inline-flex px-3 py-1 text-sm font-medium rounded-full ${statusConfig.className}`}>
          {statusConfig.label}
        </span>
      </div>

      {/* Details */}
      <div className="space-y-3 text-sm">
        {unit.zone_code && (
          <div className="flex justify-between">
            <span className="text-gray-500">Zone</span>
            <span className="font-medium">{unit.zone_code}</span>
          </div>
        )}
        {unit.size_class && (
          <div className="flex justify-between">
            <span className="text-gray-500">Size</span>
            <span className="font-medium">{unit.size_class}</span>
          </div>
        )}
      </div>

      {/* Features */}
      <div className="flex flex-wrap gap-2">
        {unit.covered && (
          <span className="inline-flex items-center gap-1 px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded">
            <Home className="h-3 w-3" /> Covered
          </span>
        )}
        {unit.accessible && (
          <span className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded">
            <Accessibility className="h-3 w-3" /> Accessible
          </span>
        )}
        {unit.ev_charging && (
          <span className="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-700 text-xs rounded">
            <Zap className="h-3 w-3" /> EV Charging
          </span>
        )}
      </div>

      {/* Current Allocation */}
      {unit.allocation && unit.currentStatus !== "available" && (
        <div className="border-t border-gray-200 pt-4 space-y-3">
          <h4 className="text-sm font-medium text-gray-900">Current Reservation</h4>

          {unit.allocation.guest_name && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">Guest</span>
              <span className="font-medium">{unit.allocation.guest_name}</span>
            </div>
          )}

          {unit.allocation.vehicle_plate && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">Plate</span>
              <span className="font-mono font-medium">{unit.allocation.vehicle_plate}</span>
            </div>
          )}

          {unit.allocation.starts_at && unit.allocation.ends_at && (
            <div className="flex justify-between text-sm">
              <span className="text-gray-500">Dates</span>
              <span className="font-medium">
                {format(new Date(unit.allocation.starts_at), "MMM d")} -{" "}
                {format(new Date(unit.allocation.ends_at), "MMM d")}
              </span>
            </div>
          )}

          {unit.allocation.reservation_id && (
            <Link href={`/app/reservations/${unit.allocation.reservation_id}`}>
              <button className="w-full mt-2 px-4 py-2 text-sm text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50">
                View Reservation â†’
              </button>
            </Link>
          )}
        </div>
      )}
    </div>
  );
}
```

### ParkingFilters.tsx
```typescript
// client/src/components/parking/ParkingFilters.tsx

import { LayoutGrid, Map } from "lucide-react";

interface Props {
  zones: string[];
  filters: { zoneCode: string; status: string };
  onChange: (filters: { zoneCode: string; status: string }) => void;
  viewMode: "grid" | "layout";
  onViewModeChange: (mode: "grid" | "layout") => void;
}

const statusOptions = [
  { value: "all", label: "All Statuses" },
  { value: "available", label: "Available" },
  { value: "occupied", label: "Occupied" },
  { value: "reserved", label: "Reserved" },
  { value: "maintenance", label: "Maintenance" },
];

export function ParkingFilters({ zones, filters, onChange, viewMode, onViewModeChange }: Props) {
  return (
    <div className="flex flex-wrap items-center gap-4">
      {/* Zone Filter */}
      <select
        value={filters.zoneCode}
        onChange={(e) => onChange({ ...filters, zoneCode: e.target.value })}
        className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
      >
        <option value="all">All Zones</option>
        {zones.map((zone) => (
          <option key={zone} value={zone}>
            Zone {zone}
          </option>
        ))}
      </select>

      {/* Status Filter */}
      <select
        value={filters.status}
        onChange={(e) => onChange({ ...filters, status: e.target.value })}
        className="px-3 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500"
      >
        {statusOptions.map((opt) => (
          <option key={opt.value} value={opt.value}>
            {opt.label}
          </option>
        ))}
      </select>

      {/* View Mode Toggle */}
      <div className="flex border border-gray-300 rounded-lg overflow-hidden ml-auto">
        <button
          onClick={() => onViewModeChange("grid")}
          className={`px-3 py-2 text-sm flex items-center gap-1 ${
            viewMode === "grid" ? "bg-blue-50 text-blue-600" : "text-gray-600 hover:bg-gray-50"
          }`}
        >
          <LayoutGrid className="h-4 w-4" />
          Grid
        </button>
        <button
          onClick={() => onViewModeChange("layout")}
          className={`px-3 py-2 text-sm flex items-center gap-1 border-l ${
            viewMode === "layout" ? "bg-blue-50 text-blue-600" : "text-gray-600 hover:bg-gray-50"
          }`}
        >
          <Map className="h-4 w-4" />
          Layout
        </button>
      </div>
    </div>
  );
}
```

### ParkingLegend.tsx
```typescript
// client/src/components/parking/ParkingLegend.tsx

export function ParkingLegend() {
  const items = [
    { color: "bg-green-500", label: "Available" },
    { color: "bg-red-500", label: "Occupied" },
    { color: "bg-yellow-500", label: "Reserved" },
    { color: "bg-gray-400", label: "Maintenance" },
  ];

  return (
    <div className="flex items-center gap-6 text-sm text-gray-600">
      <span className="font-medium">Legend:</span>
      {items.map((item) => (
        <div key={item.label} className="flex items-center gap-2">
          <div className={`w-4 h-3 rounded ${item.color}`}></div>
          <span>{item.label}</span>
        </div>
      ))}
      <div className="flex items-center gap-2">
        <div className="w-4 h-3 rounded bg-gray-300 border-2 border-blue-300"></div>
        <span>Accessible</span>
      </div>
    </div>
  );
}
```

---

## 5) BACKEND ENDPOINTS (CORRECTED)
```typescript
// server/routes/p2-parking.ts

import { Router } from "express";
import { sql } from "drizzle-orm";
import { db } from "@/server/db";

export const parkingRouter = Router();

// GET /api/p2/parking/units
parkingRouter.get("/units", async (req, res) => {
  try {
    const propertyId = String(req.query.propertyId || "").trim();
    const zoneCode = String(req.query.zoneCode || "").trim() || null;

    if (!propertyId) {
      return res.status(400).json({
        ok: false,
        error: { code: "BAD_REQUEST", message: "propertyId required" },
      });
    }

    // TODO: Verify propertyId belongs to current tenant via your existing auth pattern
    // Example: const tenantId = req.tenantId; validate property.tenant_id === tenantId

    const result = await db.execute(sql`
      SELECT 
        u.id,
        u.code,
        u.name,
        u.unit_type,
        u.status,
        u.layout_x,
        u.layout_y,
        u.layout_rotation,
        u.layout_shape,
        u.layout_ref,
        d.zone_code,
        d.size_class,
        COALESCE(d.covered, false) as covered,
        COALESCE(d.accessible, false) as accessible,
        COALESCE(d.ev_charging, false) as ev_charging
      FROM cc_units u
      LEFT JOIN cc_parking_unit_details d ON d.unit_id = u.id
      WHERE u.property_id = ${propertyId}::uuid
        AND u.unit_type = 'parking_stall'
        AND (${zoneCode}::text IS NULL OR d.zone_code = ${zoneCode})
      ORDER BY d.zone_code NULLS LAST, u.sort_order, u.code
    `);

    const propertyResult = await db.execute(sql`
      SELECT id, name FROM cc_properties WHERE id = ${propertyId}::uuid
    `);

    res.json({
      ok: true,
      units: result.rows,
      property: propertyResult.rows[0] || null,
    });
  } catch (e: any) {
    console.error("Error fetching parking units:", e);
    res.status(500).json({
      ok: false,
      error: { code: "INTERNAL", message: e.message },
    });
  }
});

// GET /api/p2/parking/availability (CORRECTED)
parkingRouter.get("/availability", async (req, res) => {
  try {
    const propertyId = String(req.query.propertyId || "").trim();
    const dateStr = String(req.query.date || new Date().toISOString().split("T")[0]);

    if (!propertyId) {
      return res.status(400).json({
        ok: false,
        error: { code: "BAD_REQUEST", message: "propertyId required" },
      });
    }

    // TODO: Verify propertyId belongs to current tenant

    // Get all parking units for the property
    const unitsResult = await db.execute(sql`
      SELECT u.id, u.code, u.status
      FROM cc_units u
      WHERE u.property_id = ${propertyId}::uuid
        AND u.unit_type = 'parking_stall'
    `);

    // FIX 1 + FIX 2: Deterministic unit_id via COALESCE + proper overlap logic
    // Overlap: starts_at < dayEnd AND ends_at > dayStart
    const allocResult = await db.execute(sql`
      SELECT
        a.id as allocation_id,
        COALESCE(a.unit_id, iu.unit_id) as unit_id,
        a.starts_at,
        a.ends_at,
        a.hold_type,
        ci.id as cart_item_id,
        c.primary_guest_name as guest_name,
        ci.vehicle_plate
      FROM cc_reservation_allocations a
      LEFT JOIN cc_inventory_units iu ON a.inventory_unit_id = iu.id
      LEFT JOIN cc_reservation_cart_items ci ON a.reservation_item_id = ci.id
      LEFT JOIN cc_reservation_carts c ON ci.cart_id = c.id
      WHERE COALESCE(a.unit_id, iu.unit_id) IN (
        SELECT id FROM cc_units
        WHERE property_id = ${propertyId}::uuid 
          AND unit_type = 'parking_stall'
      )
      AND a.starts_at < (${dateStr}::date + interval '1 day')
      AND a.ends_at > ${dateStr}::date
    `);

    // FIX 3: Handle multiple allocations per unit - pick confirmed first
    const byUnit = new Map<string, any[]>();
    for (const row of allocResult.rows as any[]) {
      const unitId = row.unit_id;
      if (!unitId) continue;
      const list = byUnit.get(unitId) ?? [];
      list.push(row);
      byUnit.set(unitId, list);
    }

    function pickAllocation(list: any[] | undefined): any | null {
      if (!list || list.length === 0) return null;
      // Priority: confirmed first, then any other
      const confirmed = list.find((x) => x.hold_type === "confirmed");
      return confirmed ?? list[0];
    }

    const allocations = (unitsResult.rows as any[]).map((unit) => {
      const alloc = pickAllocation(byUnit.get(unit.id));
      let status = "available";

      if (unit.status === "maintenance") {
        status = "maintenance";
      } else if (alloc) {
        status = alloc.hold_type === "confirmed" ? "occupied" : "reserved";
      }

      return {
        unit_id: unit.id,
        unit_code: unit.code,
        status,
        allocation_id: alloc?.allocation_id || null,
        guest_name: alloc?.guest_name || null,
        vehicle_plate: alloc?.vehicle_plate || null,
        starts_at: alloc?.starts_at || null,
        ends_at: alloc?.ends_at || null,
        reservation_id: alloc?.cart_item_id || null,
      };
    });

    res.json({ ok: true, date: dateStr, allocations });
  } catch (e: any) {
    console.error("Error fetching parking availability:", e);
    res.status(500).json({
      ok: false,
      error: { code: "INTERNAL", message: e.message },
    });
  }
});
```

Mount in server:
```typescript
import { parkingRouter } from "./routes/p2-parking";
app.use("/api/p2/parking", parkingRouter);
```

---

## 6) ROUTE REGISTRATION
```typescript
import ParkingPlanPage from "@/pages/app/ParkingPlanPage";

<Route path="/app/parking/plan" component={ParkingPlanPage} />
```

---

## 7) QA REQUIREMENTS

- [ ] `/app/parking/plan` renders without console errors
- [ ] Grid layout shows stalls grouped by zone (fallback when no layout data)
- [ ] Positioned layout works if units have `layout_x/y` populated
- [ ] Color coding: green=available, red=occupied, yellow=reserved, gray=maintenance
- [ ] Clicking stall shows detail panel with correct data
- [ ] Detail panel shows allocation info when occupied/reserved
- [ ] "View Reservation" link navigates correctly
- [ ] Date picker changes availability display
- [ ] Filters (zone, status) work correctly
- [ ] View mode toggle (grid/layout) works
- [ ] Loading states display during fetch
- [ ] Empty state when no parking units
- [ ] **NO currency displayed anywhere**
- [ ] **Uses "reservation" not "booking"**
- [ ] Stable selectors:
  - `data-testid="parking-plan"` on page
  - `data-testid="parking-stall-{id}"` per stall
  - `data-testid="parking-detail-panel"` on panel

---

## 8) STOP CONDITION

After PROMPT 4:
- STOP
- Report:
  1. Files created
  2. Endpoints created
  3. Whether layout data exists (`layout_x/y` populated or all null)
  4. Confirmation it renders at `/app/parking/plan`

After PROMPT 4, next is:
- PROMPT 5 â€” Marina Plan View (same pattern, different unit_type)