PROMPT 4R: Unified Rental Browser with Abstraction Layer
sql-- =====================================================================
-- RENTAL ABSTRACTION LAYER
-- Unifies accommodations + equipment + tools under one booking flow
-- =====================================================================

-- =====================================================================
-- 1. RENTAL ASSET TYPES (Categories that span all rentals)
-- =====================================================================

-- We already have cc_rental_categories for equipment
-- Let's add accommodation types to make it unified

INSERT INTO cc_rental_categories (name, slug, icon, required_waiver_slug, minimum_age, sort_order) VALUES
('Accommodations', 'accommodations', 'üè†', NULL, 18, 1),
('Cottages & Cabins', 'cottages', 'üè°', NULL, 18, 2),
('RV & Camping', 'rv-camping', 'üèïÔ∏è', NULL, 18, 3)
ON CONFLICT (slug) DO NOTHING;

-- =====================================================================
-- 2. UNIFIED AVAILABILITY VIEW
-- Shows availability across ALL rental types
-- =====================================================================

CREATE OR REPLACE VIEW v_unified_rentals AS
-- Equipment rentals (kayaks, ATVs, tools, parking)
SELECT 
    'equipment' as rental_type,
    ri.id as asset_id,
    ri.name,
    ri.slug,
    ri.description,
    rc.name as category,
    rc.slug as category_slug,
    rc.icon as category_icon,
    ri.home_community_id as community_id,
    c.name as community_name,
    ri.location_name,
    
    -- Pricing
    ri.pricing_model,
    ri.rate_hourly,
    ri.rate_half_day,
    ri.rate_daily,
    ri.rate_weekly,
    ri.damage_deposit,
    
    -- Capacity/details
    ri.capacity,
    ri.brand,
    ri.model,
    ri.included_items,
    ri.photos,
    
    -- Requirements
    rc.required_waiver_slug,
    rc.required_document_type,
    rc.minimum_age,
    
    -- Availability
    ri.is_available,
    ri.available_from,
    ri.available_until,
    ri.min_rental_hours,
    ri.max_rental_hours,
    ri.buffer_minutes,
    
    -- Owner
    ri.owner_individual_id,
    ri.owner_tenant_id,
    ri.owner_name,
    
    ri.status,
    ri.created_at

FROM cc_rental_items ri
JOIN cc_rental_categories rc ON rc.id = ri.category_id
LEFT JOIN sr_communities c ON c.id = ri.home_community_id
WHERE ri.status = 'active'

UNION ALL

-- Accommodations (from existing STR system if you have it)
-- This assumes you have an accommodations or properties table
-- Adjust table/column names to match your existing schema
SELECT 
    'accommodation' as rental_type,
    p.id as asset_id,
    p.name,
    p.slug,
    p.description,
    'Accommodations' as category,
    'accommodations' as category_slug,
    'üè†' as category_icon,
    p.community_id,
    c.name as community_name,
    p.address as location_name,
    
    -- Pricing (accommodations are typically nightly)
    'daily' as pricing_model,
    NULL as rate_hourly,
    NULL as rate_half_day,
    p.base_nightly_rate as rate_daily,
    p.base_nightly_rate * 7 * 0.9 as rate_weekly, -- 10% weekly discount
    p.damage_deposit,
    
    -- Capacity
    p.max_guests as capacity,
    NULL as brand,
    NULL as model,
    p.amenities as included_items,
    p.photos,
    
    -- Requirements (accommodations usually don't need waivers)
    NULL as required_waiver_slug,
    NULL as required_document_type,
    18 as minimum_age,
    
    -- Availability
    p.is_active as is_available,
    '14:00'::time as available_from,  -- Check-in time
    '11:00'::time as available_until, -- Check-out time
    24.0 as min_rental_hours,  -- 1 night minimum
    NULL as max_rental_hours,
    240 as buffer_minutes,  -- 4 hour turnover
    
    -- Owner
    p.owner_user_id as owner_individual_id,
    p.owner_tenant_id,
    COALESCE(
        (SELECT full_name FROM cc_individuals WHERE id = p.owner_user_id),
        (SELECT name FROM cc_tenants WHERE id = p.owner_tenant_id),
        'Property Owner'
    ) as owner_name,
    
    CASE WHEN p.is_active THEN 'active' ELSE 'inactive' END as status,
    p.created_at

FROM accommodation_properties p
LEFT JOIN sr_communities c ON c.id = p.community_id
WHERE p.is_active = true;

-- =====================================================================
-- 3. UNIFIED BOOKING CHECK FUNCTION
-- Works for any rental type
-- =====================================================================

CREATE OR REPLACE FUNCTION check_rental_availability(
    p_rental_type TEXT,
    p_asset_id UUID,
    p_start_ts TIMESTAMPTZ,
    p_end_ts TIMESTAMPTZ
) RETURNS JSON AS $$
DECLARE
    v_conflicts INTEGER;
    v_asset_available BOOLEAN;
    v_buffer_minutes INTEGER;
BEGIN
    -- Get asset info
    IF p_rental_type = 'equipment' THEN
        SELECT is_available, buffer_minutes 
        INTO v_asset_available, v_buffer_minutes
        FROM cc_rental_items WHERE id = p_asset_id;
        
        -- Check for conflicting bookings
        SELECT COUNT(*) INTO v_conflicts
        FROM cc_rental_bookings
        WHERE rental_item_id = p_asset_id
        AND status NOT IN ('cancelled', 'completed')
        AND (
            (starts_at < p_end_ts + (v_buffer_minutes || ' minutes')::interval) 
            AND 
            (ends_at + (v_buffer_minutes || ' minutes')::interval > p_start_ts)
        );
        
    ELSIF p_rental_type = 'accommodation' THEN
        -- Check accommodation availability
        SELECT is_active INTO v_asset_available
        FROM accommodation_properties WHERE id = p_asset_id;
        
        -- Check for conflicting bookings (adjust to your booking table)
        SELECT COUNT(*) INTO v_conflicts
        FROM accommodation_bookings
        WHERE property_id = p_asset_id
        AND status NOT IN ('cancelled')
        AND (check_in_date < p_end_ts::date AND check_out_date > p_start_ts::date);
        
        v_buffer_minutes := 240; -- 4 hour turnover
    END IF;
    
    RETURN json_build_object(
        'available', v_asset_available AND v_conflicts = 0,
        'conflicts', v_conflicts,
        'buffer_minutes', v_buffer_minutes,
        'message', CASE 
            WHEN NOT v_asset_available THEN 'Asset is not available'
            WHEN v_conflicts > 0 THEN 'Time slot conflicts with existing booking'
            ELSE 'Available'
        END
    );
END;
$$ LANGUAGE plpgsql;

-- =====================================================================
-- 4. UNIFIED PRICING CALCULATOR
-- =====================================================================

CREATE OR REPLACE FUNCTION calculate_rental_price(
    p_rental_type TEXT,
    p_asset_id UUID,
    p_start_ts TIMESTAMPTZ,
    p_end_ts TIMESTAMPTZ
) RETURNS JSON AS $$
DECLARE
    v_duration_hours NUMERIC;
    v_duration_days NUMERIC;
    v_pricing_model TEXT;
    v_rate_hourly NUMERIC;
    v_rate_half_day NUMERIC;
    v_rate_daily NUMERIC;
    v_rate_weekly NUMERIC;
    v_damage_deposit NUMERIC;
    v_subtotal NUMERIC;
    v_best_rate TEXT;
BEGIN
    -- Calculate duration
    v_duration_hours := EXTRACT(EPOCH FROM (p_end_ts - p_start_ts)) / 3600;
    v_duration_days := CEIL(v_duration_hours / 24);
    
    -- Get pricing based on rental type
    IF p_rental_type = 'equipment' THEN
        SELECT pricing_model, rate_hourly, rate_half_day, rate_daily, rate_weekly, damage_deposit
        INTO v_pricing_model, v_rate_hourly, v_rate_half_day, v_rate_daily, v_rate_weekly, v_damage_deposit
        FROM cc_rental_items WHERE id = p_asset_id;
    ELSE
        -- Accommodation pricing
        SELECT 'daily', NULL, NULL, base_nightly_rate, base_nightly_rate * 7 * 0.9, damage_deposit
        INTO v_pricing_model, v_rate_hourly, v_rate_half_day, v_rate_daily, v_rate_weekly, v_damage_deposit
        FROM accommodation_properties WHERE id = p_asset_id;
    END IF;
    
    -- Calculate best price based on duration
    IF v_duration_hours <= 4 AND v_rate_hourly IS NOT NULL THEN
        v_subtotal := v_rate_hourly * v_duration_hours;
        v_best_rate := 'hourly';
    ELSIF v_duration_hours <= 5 AND v_rate_half_day IS NOT NULL THEN
        v_subtotal := v_rate_half_day;
        v_best_rate := 'half_day';
    ELSIF v_duration_days <= 6 AND v_rate_daily IS NOT NULL THEN
        v_subtotal := v_rate_daily * v_duration_days;
        v_best_rate := 'daily';
    ELSIF v_rate_weekly IS NOT NULL THEN
        -- Use weekly rate for 7+ days
        v_subtotal := v_rate_weekly * CEIL(v_duration_days / 7.0);
        v_best_rate := 'weekly';
    ELSE
        v_subtotal := COALESCE(v_rate_daily, v_rate_hourly * 8, 0) * v_duration_days;
        v_best_rate := 'daily';
    END IF;
    
    RETURN json_build_object(
        'duration_hours', ROUND(v_duration_hours, 2),
        'duration_days', v_duration_days,
        'pricing_model', v_best_rate,
        'rate_applied', CASE v_best_rate
            WHEN 'hourly' THEN v_rate_hourly
            WHEN 'half_day' THEN v_rate_half_day
            WHEN 'daily' THEN v_rate_daily
            WHEN 'weekly' THEN v_rate_weekly
        END,
        'subtotal', ROUND(v_subtotal, 2),
        'damage_deposit', COALESCE(v_damage_deposit, 0),
        'tax', ROUND(v_subtotal * 0.12, 2), -- 12% tax (GST + PST in BC)
        'total', ROUND(v_subtotal * 1.12 + COALESCE(v_damage_deposit, 0), 2)
    );
END;
$$ LANGUAGE plpgsql;

-- =====================================================================
-- 5. QUICK CHECKOUT ELIGIBILITY (Enhanced)
-- =====================================================================

CREATE OR REPLACE FUNCTION can_checkout_unified(
    p_individual_id UUID,
    p_rental_type TEXT,
    p_asset_id UUID
) RETURNS JSON AS $$
DECLARE
    v_required_waiver TEXT;
    v_required_document TEXT;
    v_min_age INTEGER;
    v_has_waiver BOOLEAN := true;
    v_has_document BOOLEAN := true;
    v_has_payment BOOLEAN;
    v_blockers TEXT[] := '{}';
BEGIN
    -- Get requirements based on rental type
    IF p_rental_type = 'equipment' THEN
        SELECT rc.required_waiver_slug, rc.required_document_type, rc.minimum_age
        INTO v_required_waiver, v_required_document, v_min_age
        FROM cc_rental_items ri
        JOIN cc_rental_categories rc ON rc.id = ri.category_id
        WHERE ri.id = p_asset_id;
    ELSE
        v_required_waiver := NULL;
        v_required_document := NULL;
        v_min_age := 18;
    END IF;
    
    -- Check waiver
    IF v_required_waiver IS NOT NULL THEN
        SELECT EXISTS(
            SELECT 1 FROM cc_signed_waivers sw
            JOIN cc_waiver_templates wt ON wt.id = sw.waiver_template_id
            WHERE sw.individual_id = p_individual_id
            AND wt.slug = v_required_waiver
            AND NOT sw.is_expired
        ) INTO v_has_waiver;
        
        IF NOT v_has_waiver THEN
            v_blockers := array_append(v_blockers, 'waiver:' || v_required_waiver);
        END IF;
    END IF;
    
    -- Check document
    IF v_required_document IS NOT NULL THEN
        SELECT EXISTS(
            SELECT 1 FROM cc_identity_documents
            WHERE individual_id = p_individual_id
            AND document_type = v_required_document
            AND verified = true
            AND NOT is_expired
        ) INTO v_has_document;
        
        IF NOT v_has_document THEN
            v_blockers := array_append(v_blockers, 'document:' || v_required_document);
        END IF;
    END IF;
    
    -- Check payment
    SELECT EXISTS(
        SELECT 1 FROM cc_payment_methods
        WHERE individual_id = p_individual_id
        AND verified = true
        AND NOT is_expired
    ) INTO v_has_payment;
    
    IF NOT v_has_payment THEN
        v_blockers := array_append(v_blockers, 'payment_method');
    END IF;
    
    RETURN json_build_object(
        'ready', v_has_waiver AND v_has_document AND v_has_payment,
        'has_waiver', v_has_waiver,
        'has_document', v_has_document,
        'has_payment', v_has_payment,
        'blockers', v_blockers,
        'required_waiver', v_required_waiver,
        'required_document', v_required_document
    );
END;
$$ LANGUAGE plpgsql;

-- =====================================================================
-- 6. SEED MORE EQUIPMENT FOR BAMFIELD
-- =====================================================================

INSERT INTO cc_rental_items (
    owner_name, 
    home_community_id, 
    category_id, 
    name, 
    slug, 
    description,
    brand, 
    model,
    capacity, 
    included_items,
    pricing_model, 
    rate_hourly, 
    rate_half_day, 
    rate_daily,
    rate_weekly,
    damage_deposit,
    min_rental_hours,
    location_name,
    photos
) VALUES
-- More kayaks
('Glenn Ballman', 
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'watercraft'),
 'Ocean Kayak - Tandem',
 'kayak-tandem-1',
 'Two-person sit-on-top kayak, stable and fun for couples',
 'Ocean Kayak', 'Malibu Two',
 2,
 '["2 lifejackets", "2 paddles", "dry bag", "safety whistle"]'::jsonb,
 'hourly', 35.00, 80.00, 140.00, 600.00, 150.00, 1,
 'West Bamfield Marina',
 '[]'::jsonb),

('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'watercraft'),
 'Stand-Up Paddleboard',
 'sup-1',
 'Stable inflatable SUP, great for calm water',
 'Red Paddle Co', 'Ride 10.6',
 1,
 '["paddle", "lifejacket", "pump", "carry bag"]'::jsonb,
 'hourly', 25.00, 55.00, 90.00, 400.00, 100.00, 1,
 'West Bamfield Marina',
 '[]'::jsonb),

-- Bicycles
('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'bicycles'),
 'Mountain Bike - Adult',
 'mtb-adult-1',
 'Hardtail mountain bike, 21-speed, fits 5''6" - 6''2"',
 'Trek', 'Marlin 5',
 1,
 '["helmet", "lock", "repair kit"]'::jsonb,
 'hourly', 15.00, 35.00, 50.00, 200.00, 100.00, 2,
 'West Bamfield Shop',
 '[]'::jsonb),

('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'bicycles'),
 'E-Bike - Step-Through',
 'ebike-1',
 'Electric assist bike, easy mount, 50km range',
 'Rad Power', 'RadCity',
 1,
 '["helmet", "lock", "charger"]'::jsonb,
 'hourly', 25.00, 60.00, 100.00, 450.00, 200.00, 2,
 'West Bamfield Shop',
 '[]'::jsonb),

-- More parking
('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'parking'),
 'Boat Trailer Parking',
 'parking-trailer-1',
 'Large spot for boat trailer, near launch ramp',
 NULL, NULL,
 1,
 '["power outlet"]'::jsonb,
 'daily', NULL, NULL, 25.00, 125.00, 0, 24,
 'West Bamfield Marina',
 '[]'::jsonb),

-- Moorage
('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'moorage'),
 'Guest Moorage - Up to 25ft',
 'moorage-25ft',
 'Moorage for boats up to 25ft, power and water available',
 NULL, NULL,
 1,
 '["power hookup", "water hookup", "wifi access"]'::jsonb,
 'daily', NULL, NULL, 45.00, 250.00, 100.00, 24,
 'West Bamfield Marina',
 '[]'::jsonb),

-- Tools available for rent
('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'tools'),
 'Pressure Washer - 3000 PSI',
 'tool-pressure-washer',
 'Commercial gas pressure washer with hose and nozzles',
 'Simpson', 'MegaShot 3200',
 1,
 '["50ft hose", "4 nozzles", "soap injector"]'::jsonb,
 'daily', NULL, 40.00, 75.00, 300.00, 200.00, 4,
 'West Bamfield Shop',
 '[]'::jsonb),

('Glenn Ballman',
 (SELECT id FROM sr_communities WHERE slug = 'bamfield'),
 (SELECT id FROM cc_rental_categories WHERE slug = 'tools'),
 'Chainsaw - 16" Bar',
 'tool-chainsaw-16',
 'Professional chainsaw for small to medium trees',
 'Stihl', 'MS 271',
 1,
 '["bar oil", "fuel mix", "safety chaps", "helmet with face shield"]'::jsonb,
 'daily', NULL, 30.00, 50.00, 200.00, 150.00, 4,
 'West Bamfield Shop',
 '[]'::jsonb)

ON CONFLICT (slug) DO NOTHING;

-- =====================================================================
-- VERIFY
-- =====================================================================

SELECT 'Unified rental system created' as status;
SELECT category, COUNT(*) as items, 
       STRING_AGG(name, ', ' ORDER BY name) as item_names
FROM cc_rental_items ri
JOIN cc_rental_categories rc ON rc.id = ri.category_id
GROUP BY category
ORDER BY category;
Now create the Rental Browser UI:
tsx// client/src/pages/rentals/RentalBrowser.tsx

import React, { useState, useEffect } from 'react';
import { useAuth } from '../../contexts/AuthContext';

interface RentalCategory {
  id: string;
  name: string;
  slug: string;
  icon: string;
  itemCount: number;
}

interface RentalItem {
  id: string;
  name: string;
  slug: string;
  description: string;
  category: string;
  categorySlug: string;
  categoryIcon: string;
  communityName: string;
  locationName: string;
  pricingModel: string;
  rateHourly: number | null;
  rateHalfDay: number | null;
  rateDaily: number | null;
  rateWeekly: number | null;
  damageDeposit: number;
  capacity: number;
  brand: string | null;
  model: string | null;
  includedItems: string[];
  photos: string[];
  requiredWaiverSlug: string | null;
  requiredDocumentType: string | null;
  minimumAge: number;
  isAvailable: boolean;
  ownerName: string;
}

interface CheckoutEligibility {
  ready: boolean;
  hasWaiver: boolean;
  hasDocument: boolean;
  hasPayment: boolean;
  blockers: string[];
  requiredWaiver: string | null;
  requiredDocument: string | null;
}

export default function RentalBrowser() {
  const { token } = useAuth();
  const [categories, setCategories] = useState<RentalCategory[]>([]);
  const [items, setItems] = useState<RentalItem[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Filters
  const [selectedCategory, setSelectedCategory] = useState<string>('all');
  const [selectedCommunity, setSelectedCommunity] = useState<string>('');
  const [searchQuery, setSearchQuery] = useState('');
  
  // Booking modal
  const [selectedItem, setSelectedItem] = useState<RentalItem | null>(null);
  const [bookingStart, setBookingStart] = useState('');
  const [bookingEnd, setBookingEnd] = useState('');
  const [bookingDuration, setBookingDuration] = useState<number>(2); // hours
  const [priceQuote, setPriceQuote] = useState<any>(null);
  const [eligibility, setEligibility] = useState<CheckoutEligibility | null>(null);
  const [bookingInProgress, setBookingInProgress] = useState(false);

  useEffect(() => {
    loadRentals();
  }, [selectedCategory, selectedCommunity]);

  async function loadRentals() {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (selectedCategory !== 'all') params.append('category', selectedCategory);
      if (selectedCommunity) params.append('community', selectedCommunity);
      
      const res = await fetch(`/api/rentals/browse?${params}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      
      if (data.success) {
        setCategories(data.categories || []);
        setItems(data.items || []);
      }
    } catch (err) {
      console.error('Failed to load rentals:', err);
    } finally {
      setLoading(false);
    }
  }

  async function selectItem(item: RentalItem) {
    setSelectedItem(item);
    setPriceQuote(null);
    setEligibility(null);
    
    // Set default booking times
    const now = new Date();
    now.setMinutes(0, 0, 0);
    now.setHours(now.getHours() + 1);
    setBookingStart(now.toISOString().slice(0, 16));
    
    const end = new Date(now);
    end.setHours(end.getHours() + 2);
    setBookingEnd(end.toISOString().slice(0, 16));
    setBookingDuration(2);
    
    // Check eligibility
    try {
      const res = await fetch(`/api/rentals/${item.id}/eligibility`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const data = await res.json();
      if (data.success) {
        setEligibility(data.eligibility);
      }
    } catch (err) {
      console.error('Failed to check eligibility:', err);
    }
  }

  async function calculatePrice() {
    if (!selectedItem || !bookingStart || !bookingEnd) return;
    
    try {
      const res = await fetch(`/api/rentals/${selectedItem.id}/quote`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` 
        },
        body: JSON.stringify({
          startTs: bookingStart,
          endTs: bookingEnd
        })
      });
      const data = await res.json();
      if (data.success) {
        setPriceQuote(data.quote);
      }
    } catch (err) {
      console.error('Failed to calculate price:', err);
    }
  }

  useEffect(() => {
    if (selectedItem && bookingStart && bookingEnd) {
      calculatePrice();
    }
  }, [bookingStart, bookingEnd, selectedItem]);

  function setDurationHours(hours: number) {
    setBookingDuration(hours);
    if (bookingStart) {
      const start = new Date(bookingStart);
      const end = new Date(start);
      end.setHours(end.getHours() + hours);
      setBookingEnd(end.toISOString().slice(0, 16));
    }
  }

  async function confirmBooking() {
    if (!selectedItem || !bookingStart || !bookingEnd || !eligibility?.ready) return;
    
    setBookingInProgress(true);
    try {
      const res = await fetch(`/api/rentals/${selectedItem.id}/book`, {
        method: 'POST',
        headers: { 
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}` 
        },
        body: JSON.stringify({
          startTs: bookingStart,
          endTs: bookingEnd
        })
      });
      const data = await res.json();
      
      if (data.success) {
        alert('Booking confirmed! Check "My Bookings" for details.');
        setSelectedItem(null);
        loadRentals();
      } else {
        alert(data.error || 'Booking failed');
      }
    } catch (err) {
      console.error('Booking failed:', err);
      alert('Booking failed');
    } finally {
      setBookingInProgress(false);
    }
  }

  const filteredItems = items.filter(item => {
    if (searchQuery) {
      const q = searchQuery.toLowerCase();
      return item.name.toLowerCase().includes(q) || 
             item.description.toLowerCase().includes(q) ||
             item.category.toLowerCase().includes(q);
    }
    return true;
  });

  const formatPrice = (item: RentalItem) => {
    if (item.rateHourly) return `$${item.rateHourly}/hr`;
    if (item.rateHalfDay) return `$${item.rateHalfDay}/half-day`;
    if (item.rateDaily) return `$${item.rateDaily}/day`;
    return 'Contact for pricing';
  };

  return (
    <div className="p-6">
      {/* Header */}
      <div className="mb-6">
        <h1 className="text-2xl font-bold text-white">Rent Equipment</h1>
        <p className="text-gray-400">Kayaks, ATVs, bikes, tools, parking & more</p>
      </div>

      {/* Category Tabs */}
      <div className="flex gap-2 mb-6 overflow-x-auto pb-2">
        <button
          onClick={() => setSelectedCategory('all')}
          className={`px-4 py-2 rounded-lg whitespace-nowrap ${
            selectedCategory === 'all'
              ? 'bg-blue-600 text-white'
              : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
          }`}
        >
          All
        </button>
        {categories.map(cat => (
          <button
            key={cat.slug}
            onClick={() => setSelectedCategory(cat.slug)}
            className={`px-4 py-2 rounded-lg whitespace-nowrap flex items-center gap-2 ${
              selectedCategory === cat.slug
                ? 'bg-blue-600 text-white'
                : 'bg-gray-800 text-gray-400 hover:bg-gray-700'
            }`}
          >
            <span>{cat.icon}</span>
            <span>{cat.name}</span>
            <span className="text-xs opacity-70">({cat.itemCount})</span>
          </button>
        ))}
      </div>

      {/* Search */}
      <div className="mb-6">
        <input
          type="text"
          placeholder="Search equipment..."
          value={searchQuery}
          onChange={(e) => setSearchQuery(e.target.value)}
          className="w-full max-w-md bg-gray-800 border border-gray-700 rounded-lg px-4 py-2 text-white placeholder-gray-500"
        />
      </div>

      {/* Items Grid */}
      {loading ? (
        <div className="text-center text-gray-400 py-12">Loading rentals...</div>
      ) : filteredItems.length === 0 ? (
        <div className="text-center text-gray-400 py-12">No equipment found</div>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
          {filteredItems.map(item => (
            <div 
              key={item.id}
              onClick={() => selectItem(item)}
              className="bg-gray-800 rounded-lg overflow-hidden cursor-pointer hover:ring-2 hover:ring-blue-500 transition-all"
            >
              {/* Image placeholder */}
              <div className="h-40 bg-gray-700 flex items-center justify-center text-6xl">
                {item.categoryIcon}
              </div>
              
              <div className="p-4">
                <div className="flex items-start justify-between mb-2">
                  <div>
                    <h3 className="text-white font-medium">{item.name}</h3>
                    <p className="text-sm text-gray-400">{item.category}</p>
                  </div>
                  {item.isAvailable ? (
                    <span className="text-xs bg-green-600/20 text-green-400 px-2 py-1 rounded">
                      Available
                    </span>
                  ) : (
                    <span className="text-xs bg-red-600/20 text-red-400 px-2 py-1 rounded">
                      Unavailable
                    </span>
                  )}
                </div>
                
                <p className="text-sm text-gray-500 mb-3 line-clamp-2">
                  {item.description}
                </p>
                
                <div className="flex items-center justify-between">
                  <div className="text-blue-400 font-semibold">
                    {formatPrice(item)}
                  </div>
                  {item.capacity > 1 && (
                    <div className="text-xs text-gray-500">
                      üë• {item.capacity} people
                    </div>
                  )}
                </div>
                
                <div className="text-xs text-gray-500 mt-2">
                  üìç {item.locationName}
                </div>
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Booking Modal */}
      {selectedItem && (
        <div className="fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
          <div className="bg-gray-800 rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            {/* Header */}
            <div className="p-6 border-b border-gray-700">
              <div className="flex items-start justify-between">
                <div>
                  <h2 className="text-xl font-bold text-white">{selectedItem.name}</h2>
                  <p className="text-gray-400">{selectedItem.category} ‚Ä¢ {selectedItem.locationName}</p>
                </div>
                <button
                  onClick={() => setSelectedItem(null)}
                  className="text-gray-400 hover:text-white text-2xl"
                >
                  √ó
                </button>
              </div>
            </div>

            <div className="p-6 space-y-6">
              {/* Description */}
              <div>
                <p className="text-gray-300">{selectedItem.description}</p>
                {selectedItem.brand && (
                  <p className="text-sm text-gray-500 mt-2">
                    {selectedItem.brand} {selectedItem.model}
                  </p>
                )}
              </div>

              {/* Included items */}
              {selectedItem.includedItems.length > 0 && (
                <div>
                  <h3 className="text-sm font-medium text-gray-400 mb-2">Included:</h3>
                  <div className="flex flex-wrap gap-2">
                    {selectedItem.includedItems.map((item, i) => (
                      <span key={i} className="text-xs bg-gray-700 text-gray-300 px-2 py-1 rounded">
                        ‚úì {item}
                      </span>
                    ))}
                  </div>
                </div>
              )}

              {/* Pricing */}
              <div className="bg-gray-900 rounded-lg p-4">
                <h3 className="text-sm font-medium text-gray-400 mb-2">Pricing:</h3>
                <div className="grid grid-cols-4 gap-2 text-center">
                  {selectedItem.rateHourly && (
                    <div className="bg-gray-800 rounded p-2">
                      <div className="text-white font-semibold">${selectedItem.rateHourly}</div>
                      <div className="text-xs text-gray-500">per hour</div>
                    </div>
                  )}
                  {selectedItem.rateHalfDay && (
                    <div className="bg-gray-800 rounded p-2">
                      <div className="text-white font-semibold">${selectedItem.rateHalfDay}</div>
                      <div className="text-xs text-gray-500">half day</div>
                    </div>
                  )}
                  {selectedItem.rateDaily && (
                    <div className="bg-gray-800 rounded p-2">
                      <div className="text-white font-semibold">${selectedItem.rateDaily}</div>
                      <div className="text-xs text-gray-500">per day</div>
                    </div>
                  )}
                  {selectedItem.rateWeekly && (
                    <div className="bg-gray-800 rounded p-2">
                      <div className="text-white font-semibold">${selectedItem.rateWeekly}</div>
                      <div className="text-xs text-gray-500">per week</div>
                    </div>
                  )}
                </div>
                {selectedItem.damageDeposit > 0 && (
                  <p className="text-xs text-gray-500 mt-2">
                    + ${selectedItem.damageDeposit} refundable deposit
                  </p>
                )}
              </div>

              {/* Booking Form */}
              <div className="bg-gray-900 rounded-lg p-4">
                <h3 className="text-sm font-medium text-gray-400 mb-3">Book Now:</h3>
                
                {/* Quick duration buttons */}
                <div className="flex gap-2 mb-4">
                  {[1, 2, 4, 8].map(hours => (
                    <button
                      key={hours}
                      onClick={() => setDurationHours(hours)}
                      className={`px-3 py-1 rounded text-sm ${
                        bookingDuration === hours
                          ? 'bg-blue-600 text-white'
                          : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                      }`}
                    >
                      {hours}h
                    </button>
                  ))}
                  <button
                    onClick={() => setDurationHours(24)}
                    className={`px-3 py-1 rounded text-sm ${
                      bookingDuration === 24
                        ? 'bg-blue-600 text-white'
                        : 'bg-gray-700 text-gray-400 hover:bg-gray-600'
                    }`}
                  >
                    1 day
                  </button>
                </div>

                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">Start</label>
                    <input
                      type="datetime-local"
                      value={bookingStart}
                      onChange={(e) => setBookingStart(e.target.value)}
                      className="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-xs text-gray-500 mb-1">End</label>
                    <input
                      type="datetime-local"
                      value={bookingEnd}
                      onChange={(e) => setBookingEnd(e.target.value)}
                      className="w-full bg-gray-800 border border-gray-700 rounded px-3 py-2 text-white text-sm"
                    />
                  </div>
                </div>

                {/* Price Quote */}
                {priceQuote && (
                  <div className="mt-4 p-3 bg-gray-800 rounded">
                    <div className="flex justify-between text-sm mb-1">
                      <span className="text-gray-400">
                        {priceQuote.duration_hours}h @ {priceQuote.pricing_model} rate
                      </span>
                      <span className="text-white">${priceQuote.subtotal}</span>
                    </div>
                    <div className="flex justify-between text-sm mb-1">
                      <span className="text-gray-400">Tax (12%)</span>
                      <span className="text-white">${priceQuote.tax}</span>
                    </div>
                    {priceQuote.damage_deposit > 0 && (
                      <div className="flex justify-between text-sm mb-1">
                        <span className="text-gray-400">Deposit (refundable)</span>
                        <span className="text-white">${priceQuote.damage_deposit}</span>
                      </div>
                    )}
                    <div className="flex justify-between text-lg font-bold mt-2 pt-2 border-t border-gray-700">
                      <span className="text-white">Total</span>
                      <span className="text-green-400">${priceQuote.total}</span>
                    </div>
                  </div>
                )}
              </div>

              {/* Eligibility Status */}
              {eligibility && (
                <div className={`p-4 rounded-lg ${
                  eligibility.ready 
                    ? 'bg-green-600/20 border border-green-600/50' 
                    : 'bg-yellow-600/20 border border-yellow-600/50'
                }`}>
                  {eligibility.ready ? (
                    <div className="flex items-center gap-2 text-green-400">
                      <span className="text-xl">‚úì</span>
                      <span>Ready to book! Waiver valid, payment on file.</span>
                    </div>
                  ) : (
                    <div>
                      <div className="text-yellow-400 font-medium mb-2">
                        Complete these before booking:
                      </div>
                      <div className="space-y-1">
                        {!eligibility.hasWaiver && (
                          <div className="flex items-center gap-2 text-sm text-yellow-300">
                            <span>‚ö†Ô∏è</span>
                            <span>Sign {eligibility.requiredWaiver} waiver</span>
                            <button className="ml-auto text-blue-400 hover:underline">Sign Now</button>
                          </div>
                        )}
                        {!eligibility.hasDocument && (
                          <div className="flex items-center gap-2 text-sm text-yellow-300">
                            <span>‚ö†Ô∏è</span>
                            <span>Add {eligibility.requiredDocument}</span>
                            <button className="ml-auto text-blue-400 hover:underline">Add</button>
                          </div>
                        )}
                        {!eligibility.hasPayment && (
                          <div className="flex items-center gap-2 text-sm text-yellow-300">
                            <span>‚ö†Ô∏è</span>
                            <span>Add payment method</span>
                            <button className="ml-auto text-blue-400 hover:underline">Add</button>
                          </div>
                        )}
                      </div>
                    </div>
                  )}
                </div>
              )}

              {/* Book Button */}
              <button
                onClick={confirmBooking}
                disabled={!eligibility?.ready || bookingInProgress || !priceQuote}
                className={`w-full py-3 rounded-lg font-semibold ${
                  eligibility?.ready && priceQuote && !bookingInProgress
                    ? 'bg-green-600 hover:bg-green-700 text-white'
                    : 'bg-gray-700 text-gray-500 cursor-not-allowed'
                }`}
              >
                {bookingInProgress ? 'Booking...' : 
                 eligibility?.ready ? `Confirm Booking - $${priceQuote?.total || '0'}` : 
                 'Complete requirements to book'}
              </button>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
Add to App.tsx:
tsx<Route path="/rentals" element={<RentalBrowser />} />
Add to navigation sidebar under a new "RENTALS" section.

This gives you:

Unified rental abstraction (equipment + accommodations can share the same booking flow)
12 rental items in Bamfield (kayaks, SUP, bikes, e-bike, parking, moorage, tools)
Smart pricing calculator (picks best rate based on duration)
Instant eligibility check (waiver valid? payment on file?)
One-click booking when everything is ready

Run this and you'll have Booqable replacement live!