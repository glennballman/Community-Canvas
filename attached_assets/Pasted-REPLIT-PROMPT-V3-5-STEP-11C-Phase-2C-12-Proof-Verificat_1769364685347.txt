REPLIT PROMPT — V3.5 — STEP 11C — Phase 2C-12 Proof Verification UX + Key Health (UI + API + Tests)

ROLE: Senior Platform Architect + QA Gatekeeper
MODE: Evidence-first, ship-correct-now. Additive schema/model changes allowed if they improve certifiability.
TERMINOLOGY LOCKED:
✅ service provider
✅ reservation
❌ contractor
❌ booking
❌ calendar

PHASE 2C-12 OBJECTIVE
Make Phase 2C-11 verification operationally usable by adding:
1) A tenant-admin UI tool to verify a Run Proof Export JSON bundle (paste/upload) and display a safe verification report
2) A Key Health panel showing signing key status (active key id, loaded public keys, consistency checks)
3) Tests proving:
   - role gating
   - UI flows and safe rendering
   - verification results map correctly to API responses
4) Proof doc:
   - proof/v3.5/step11c-phase2c12-proof-verification-ux-key-health-proof.md

CONTEXT (AS BUILT)
- POST /api/app/negotiation-proof-export/verify exists (2C-11)
- Keys loaded from:
  - CC_EXPORT_SIGNING_KEY_ID
  - CC_EXPORT_SIGNING_PRIVATE_KEY_PEM (signing only)
  - CC_EXPORT_SIGNING_PUBLIC_KEYS_JSON (verification)
- Negotiation audit settings UI exists (2C-9)
- Export exists (2C-10) and attested exports exist (2C-11)

DELIVERABLES
A) API endpoint: GET /api/app/export-signing-key-health  (admin-only)
B) UI page: /app/settings/proof-verification (or tab within Negotiation Audit settings area)
C) Components:
   - ProofVerificationPanel (paste JSON, upload file, verify)
   - KeyHealthPanel (read-only)
D) Copy tokens under:
   - settings.proof_verification.*
   - settings.key_health.*
E) Tests (API + UI)
F) Proof doc

========================================================
STEP 0 — IA DECISION (NO GUESSING)
========================================================
Place UI in Settings:
Option A (preferred): New settings page /app/settings/proof-verification
Option B: Add “Verify” tab inside existing NegotiationAuditPage or negotiation settings area

Pick the one that matches existing settings routing patterns.
Document choice and route wiring in proof doc.

========================================================
STEP 1 — API: Export Signing Key Health (Admin-only)
========================================================
Create:
- server/routes/export-key-health.ts

Endpoint:
GET /api/app/export-signing-key-health

Auth:
- requireTenant
- requireRole('tenant_owner','tenant_admin')

Response (API envelope):
{
  ok: true,
  active_key_id: string | null,                 // from CC_EXPORT_SIGNING_KEY_ID
  public_key_ids: string[],                      // keys present in CC_EXPORT_SIGNING_PUBLIC_KEYS_JSON
  has_private_key_configured: boolean,           // true if CC_EXPORT_SIGNING_PRIVATE_KEY_PEM present (do NOT return the key)
  active_key_has_public_key: boolean,            // active key id exists in public keys
  warnings: string[]                             // safe messages only
}

Warnings examples (safe):
- "Active signing key id is not set."
- "No public keys are configured for verification."
- "Active signing key id is not present in public keys (verification may fail)."
- "Private signing key is not configured (exports cannot be attested)."

Do NOT include any key material or key lengths; just booleans/ids.

========================================================
STEP 2 — UI: Proof Verification Panel
========================================================
Create:
- client/src/pages/app/settings/ProofVerificationPage.tsx (if Option A)
OR integrate as tab in existing settings UI.

Features:
A) Input methods:
1) Paste area (textarea) for JSON
2) Upload file (.json) (optional but recommended)
   - Read file as text and populate textarea

B) Verify action:
- Button: “Verify proof”
- Calls POST /api/app/negotiation-proof-export/verify with body:
  { export_json: "<string>" }
- Show loading state

C) Result rendering (safe, non-leaky):
If verified=true:
- Big status: “Verified”
- Show:
  - signing_key_id
  - export_hash_sha256 (masked by default, copy button)
  - computed_hash_sha256 (masked by default, copy button) (if API returns it; if not, omit)
  - signature_scope
  - signed_at (if present)
If verified=false:
- Big status: “Not verified”
- Show reason from API, but sanitize to safe set (map reasons)
  - e.g. invalid_json, missing_attestation, unknown_key_id, hash_mismatch, bad_signature
Do NOT show stack traces or internal errors.

D) Masking rules:
- Hash masking: first 8 + last 4 (as in 2C-9)
- Provide “Show values” toggle for advanced view (optional); default masked
- Copy copies full value

E) UX considerations:
- Clear input button
- Sample helper text: “Paste an export JSON bundle from Run Proof Export (v2 attested).”

Copy tokens:
settings.proof_verification.title
settings.proof_verification.description
settings.proof_verification.input.label
settings.proof_verification.input.placeholder
settings.proof_verification.action.verify
settings.proof_verification.action.clear
settings.proof_verification.status.verified
settings.proof_verification.status.not_verified
settings.proof_verification.field.signing_key_id
settings.proof_verification.field.export_hash
settings.proof_verification.field.signature_scope
settings.proof_verification.field.signed_at
settings.proof_verification.field.reason
settings.proof_verification.action.copy
settings.proof_verification.action.copied
settings.proof_verification.action.show_values / hide_values
settings.proof_verification.error.invalid_json (etc.)

========================================================
STEP 3 — UI: Key Health Panel
========================================================
Create:
- client/src/components/KeyHealthPanel.tsx

Display:
- Active key id
- Public key ids list (chips)
- Private key configured (yes/no)
- Active key has public key (yes/no)
- Warnings list

Fetch:
- GET /api/app/export-signing-key-health

Place on ProofVerificationPage above/beside verification panel.

Copy tokens:
settings.key_health.title
settings.key_health.field.active_key_id
settings.key_health.field.public_keys
settings.key_health.field.private_key_configured
settings.key_health.field.active_key_has_public_key
settings.key_health.warnings.title
settings.key_health.empty.no_public_keys

========================================================
STEP 4 — Route/Nav Wiring
========================================================
- Add navigation entry under Admin / Settings section:
  - “Proof verification” (admin-only)
- Ensure route guard matches server role guards.

========================================================
STEP 5 — Tests (MANDATORY)
========================================================
A) API tests
Create:
- server/routes/__tests__/exportKeyHealth.test.ts

Test cases:
1) Requires auth/role (401/403 as per conventions)
2) With env configured:
   - active_key_id returned
   - public_key_ids includes active id => active_key_has_public_key true
3) Missing public keys => warning includes safe message
4) Missing private key => has_private_key_configured false, warning present

Also add/extend verify endpoint tests if needed:
- Ensure verify returns safe reason codes, not raw errors

B) UI tests (React Testing Library)
Create:
- client/src/pages/app/settings/__tests__/ProofVerificationPage.test.tsx

Test cases:
1) Renders KeyHealthPanel with mocked API response
2) Paste JSON -> click Verify -> renders Verified state
3) Invalid JSON -> shows invalid_json error message (safe)
4) Not verified -> shows reason mapped message
5) Masking + copy:
   - hash displayed masked by default
   - copy calls clipboard with full hash

Mock:
- fetch for health + verify endpoints
- navigator.clipboard.writeText

========================================================
STEP 6 — Proof Doc (MANDATORY)
========================================================
Create:
proof/v3.5/step11c-phase2c12-proof-verification-ux-key-health-proof.md

Include:
A) Files changed list
B) UI screenshots/descriptions:
   - Key health panel
   - Verification success
   - Verification failure (safe reason)
C) API samples:
   - key health response
   - verify response (redacted)
D) Tests summary + commands + PASS output excerpt
E) Safety notes:
   - no key material returned
   - reasons are sanitized

========================================================
ACCEPTANCE CRITERIA (MUST PASS)
========================================================
1) Admin-only access enforced on API and UI
2) Key health endpoint returns safe status + warnings without key material
3) Proof verification UI can verify a real attested export and display masked values by default
4) Failure cases show safe reason codes/messages
5) Tests pass
6) Proof doc exists with evidence

OUTPUT REQUIRED FROM REPLIT
- Summary of changes
- New routes/pages and nav wiring
- Test command output summary
- Proof doc path and contents (or excerpts)
