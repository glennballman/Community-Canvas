**EXPEDITION ENGINE - PROMPT 1: Trip Foundations**

We now have clean trip tables:
- cc_trips (the container)
- cc_trip_participants (who's going)
- cc_trip_route_points (journey segments)
- cc_trip_segment_templates (reference data)
- cc_trip_passengers (travelers)

Now we add expedition-grade fields and new tables for calendar + operations.

## PHASE 1: Add Expedition Fields to cc_trips
```sql
-- Portal/tenant context
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS portal_id uuid;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS tenant_id uuid;

-- Magic link for sharing
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS access_code varchar UNIQUE;

-- Primary contact (the trip organizer)
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS primary_contact_name varchar;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS primary_contact_email varchar;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS primary_contact_phone varchar;

-- Origin (for route planning)
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS origin_name varchar;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS origin_type varchar; -- vancouver_area|victoria_area|nanaimo_area|other_bc|out_of_province
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS origin_lat numeric(10,7);
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS origin_lng numeric(10,7);

-- Vehicle/trailer (critical for BC logistics)
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS has_vehicle boolean DEFAULT true;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS has_trailer boolean DEFAULT false;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS trailer_type varchar; -- boat|camper|utility|none
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS boat_length_ft integer; -- including motors!
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS trailer_length_ft integer;

-- Outbound handoff (growth engine)
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS next_destination_name varchar;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS next_destination_lat numeric(10,7);
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS next_destination_lng numeric(10,7);
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS next_destination_email varchar;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS next_destination_phone varchar;
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS coordinate_handoff boolean DEFAULT false;

-- Live conditions tracking
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS current_alert_level varchar; -- green|yellow|red
ALTER TABLE cc_trips ADD COLUMN IF NOT EXISTS last_conditions_check timestamptz;

-- Create indexes
CREATE INDEX IF NOT EXISTS idx_cc_trips_access_code ON cc_trips(access_code);
CREATE INDEX IF NOT EXISTS idx_cc_trips_portal ON cc_trips(portal_id);
CREATE INDEX IF NOT EXISTS idx_cc_trips_dates ON cc_trips(start_date, end_date);
```

## PHASE 2: Create cc_trip_itinerary_items (Calendar Events - Booked + Unscheduled Fun)

This is the calendar backbone. Holds BOTH booked items AND unscheduled magic moments.
```sql
CREATE TABLE IF NOT EXISTS cc_trip_itinerary_items (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid NOT NULL REFERENCES cc_trips(id) ON DELETE CASCADE,
  
  -- What kind of item
  item_type varchar NOT NULL, 
  -- travel|accommodation|parking|charter|rental|meal|activity|moment|flex|photo|safety|handoff
  
  title varchar NOT NULL,
  description text,
  
  -- Lane A (Hard Commit) vs Lane B (Soft Magic)
  is_booked boolean NOT NULL DEFAULT false,
  reservation_id uuid, -- Links to cc_reservations if booked
  
  -- Status
  status varchar NOT NULL DEFAULT 'idea', -- idea|planned|booked|confirmed|completed|skipped
  
  -- When (calendar positioning)
  day_date date NOT NULL,
  start_time time,
  end_time time,
  all_day boolean DEFAULT false,
  
  -- Who (which party members)
  everyone boolean DEFAULT true,
  assigned_participant_ids uuid[],
  
  -- Where
  location_name varchar,
  location_lat numeric(10,7),
  location_lng numeric(10,7),
  
  -- Weather intelligence
  weather_sensitive boolean DEFAULT false,
  indoor_alternative text,
  
  -- Photo prompts
  photo_moment boolean DEFAULT false,
  suggested_caption text,
  
  -- External links
  external_url text,
  external_booking_ref varchar,
  
  -- Display
  icon varchar,
  color varchar,
  sort_order integer DEFAULT 0,
  
  -- Metadata
  created_by varchar, -- 'system'|'organizer'|'participant'
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX idx_cc_trip_itinerary_items_trip ON cc_trip_itinerary_items(trip_id);
CREATE INDEX idx_cc_trip_itinerary_items_day ON cc_trip_itinerary_items(day_date);
CREATE INDEX idx_cc_trip_itinerary_items_type ON cc_trip_itinerary_items(item_type);
CREATE INDEX idx_cc_trip_itinerary_items_booked ON cc_trip_itinerary_items(is_booked) WHERE is_booked = true;
```

## PHASE 3: Create cc_trip_timepoints (Operational Anchors - Staff Actions)

This powers Arrival Day Ops. Every operational moment staff needs to act on.
```sql
CREATE TABLE IF NOT EXISTS cc_trip_timepoints (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  trip_id uuid NOT NULL REFERENCES cc_trips(id) ON DELETE CASCADE,
  
  -- What kind of timepoint
  kind varchar NOT NULL,
  -- arrival_expected|departure_expected|bag_drop|bag_transfer|
  -- checkin_ready|checkout_due|charter_depart|charter_return|
  -- ferry_depart|ferry_arrive|water_taxi|equipment_pickup|equipment_return|
  -- late_arrival_risk|handoff_eta|custom
  
  -- Time (exact OR window)
  time_exact timestamptz,
  time_window_start timestamptz,
  time_window_end timestamptz,
  time_confidence varchar NOT NULL DEFAULT 'window', -- exact|window|estimated|unknown
  
  -- Location
  location_name varchar,
  location_lat numeric(10,7),
  location_lng numeric(10,7),
  
  -- Staff action
  staff_action text, -- "Move bags to Oceanview Cottage"
  staff_assigned_to uuid,
  completed_at timestamptz,
  completed_by uuid,
  
  -- Guest-facing notes
  guest_notes text, -- "Captain Mike will meet you at Dock 4"
  
  -- Internal notes
  internal_notes text,
  
  -- Link to itinerary item if relevant
  itinerary_item_id uuid REFERENCES cc_trip_itinerary_items(id) ON DELETE SET NULL,
  
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX idx_cc_trip_timepoints_trip ON cc_trip_timepoints(trip_id);
CREATE INDEX idx_cc_trip_timepoints_kind ON cc_trip_timepoints(kind);
CREATE INDEX idx_cc_trip_timepoints_time ON cc_trip_timepoints(COALESCE(time_exact, time_window_start));
CREATE INDEX idx_cc_trip_timepoints_incomplete ON cc_trip_timepoints(trip_id) WHERE completed_at IS NULL;
```

## PHASE 4: Create cc_portal_moments (Curated Fun Suggestions per Portal)

Pre-loaded suggestions like "Sunset at Pachena Beach" that can be one-click added to any trip.
```sql
CREATE TABLE IF NOT EXISTS cc_portal_moments (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  portal_id uuid NOT NULL,
  
  title varchar NOT NULL,
  description text,
  
  moment_type varchar NOT NULL, -- stop|viewpoint|beach|play|swim|hike|campfire|rainy_day|sunset|sunrise|treat|photo
  
  -- When is it best
  best_time_of_day varchar, -- morning|afternoon|evening|any
  best_weather varchar, -- clear|any|rainy (for rainy day activities)
  
  -- Where
  location_name varchar,
  location_lat numeric(10,7),
  location_lng numeric(10,7),
  
  -- Who
  kid_friendly boolean DEFAULT true,
  
  -- Tips
  pro_tip text,
  safety_note text,
  
  -- Photo
  photo_moment boolean DEFAULT true,
  suggested_caption text,
  
  -- Media
  image_url text,
  
  -- Display
  icon varchar,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  
  created_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX idx_cc_portal_moments_portal ON cc_portal_moments(portal_id);
CREATE INDEX idx_cc_portal_moments_type ON cc_portal_moments(moment_type);
```

## PHASE 5: Seed Bamfield Portal Moments

Find the Bamfield portal ID first:
```sql
SELECT id, name, slug FROM cc_portals WHERE slug ILIKE '%bamfield%' OR name ILIKE '%bamfield%' OR name ILIKE '%woods%end%' LIMIT 5;
```

Then seed moments (replace PORTAL_ID with actual UUID):
```sql
INSERT INTO cc_portal_moments (portal_id, title, description, moment_type, best_time_of_day, location_name, kid_friendly, pro_tip, photo_moment, suggested_caption, icon) VALUES

-- Stops on the way
('PORTAL_ID', 'Goats on the Roof', 'Famous Coombs Market with goats grazing on the grass roof. Great snacks and photo op!', 'stop', 'any', 'Coombs, BC', true, 'Get ice cream and let kids spot all the goats', true, 'Goats on the roof! üêê', 'üêê'),

('PORTAL_ID', 'Cathedral Grove', 'Walk among 800-year-old Douglas Firs. Short accessible trail.', 'stop', 'any', 'MacMillan Provincial Park', true, 'Takes 20-30 min. Worth the stop!', true, 'Ancient giants üå≤', 'üå≤'),

('PORTAL_ID', 'Cameron Lake Picnic', 'Scenic lake stop. Stretch legs, skip rocks, bathroom break.', 'stop', 'any', 'Cameron Lake', true, 'Good bathroom stop before the gravel road', true, 'Cameron Lake calm ‚ú®', 'üèûÔ∏è'),

-- Beach & Water
('PORTAL_ID', 'Brady''s Beach', 'Sandy beach perfect for families. Tidal pools at low tide.', 'beach', 'morning', 'Brady''s Beach, Bamfield', true, 'Check tide times - low tide exposes amazing pools', true, 'Beach day! üèñÔ∏è', 'üèñÔ∏è'),

('PORTAL_ID', 'Pachena Beach Sunset', 'The best sunset spot. Wide sandy beach with dramatic skies.', 'sunset', 'evening', 'Pachena Beach', true, 'Bring a blanket and snacks', true, 'Pachena sunset üåÖ', 'üåÖ'),

-- Activities
('PORTAL_ID', 'Boardwalk Stroll', 'Walk the historic Bamfield boardwalk connecting East and West Bamfield.', 'activity', 'any', 'Bamfield Boardwalk', true, 'Get ice cream at the general store', true, 'Boardwalk life üö∂', 'üö∂'),

('PORTAL_ID', 'Campfire Night', 'Evening campfire at your cottage. Check fire ban status first!', 'campfire', 'evening', 'Your cottage', true, 'If fire ban active, propane fire pits are OK', true, 'Campfire vibes üî•', 'üî•'),

('PORTAL_ID', 'Badminton & Lawn Games', 'Bring rackets or borrow from the lodge. Great for kids!', 'play', 'afternoon', 'Lodge grounds', true, 'Ask at front desk for equipment', false, NULL, 'üè∏'),

-- Rainy Day
('PORTAL_ID', 'Bamfield Marine Sciences Centre', 'World-class marine research station with public tours and touch tanks.', 'rainy_day', 'any', 'BMSC, Bamfield', true, 'Check tour times in advance', true, 'Science day! üî¨', 'üî¨'),

('PORTAL_ID', 'Cozy Reading Day', 'Sometimes the best vacation day is no plans at all.', 'rainy_day', 'any', 'Your cottage', true, 'Bring books, games, and snacks', false, NULL, 'üìö'),

('PORTAL_ID', 'Storm Watching', 'BC coast storms are spectacular. Watch from the safety of your cottage.', 'rainy_day', 'any', 'Your cottage', true, 'Hot chocolate mandatory', true, 'Storm watching ‚õàÔ∏è', '‚õàÔ∏è'),

-- Photo moments
('PORTAL_ID', 'Catch of the Day Photo', 'Document your fishing success at the dock!', 'photo', 'any', 'Government Dock', true, 'Best light in late afternoon', true, 'Look what we caught! üé£', 'üé£'),

('PORTAL_ID', 'Sunrise Coffee', 'Early morning coffee on the deck watching the harbour wake up.', 'sunrise', 'morning', 'Your cottage deck', true, 'Set an alarm - worth it!', true, 'Morning magic ‚òï', '‚òï');
```

## PHASE 6: Create Access Code Generator

Create file: `server/lib/accessCode.ts`
```typescript
import { customAlphabet } from 'nanoid';

// Alphabet without ambiguous characters (no 0/O, 1/I/L)
const alphabet = '23456789ABCDEFGHJKMNPQRSTUVWXYZ';
const generateCode = customAlphabet(alphabet, 6);

export function generateTripAccessCode(portalSlug: string): string {
  const prefix = portalSlug.substring(0, 3).toUpperCase();
  const code = generateCode();
  return `${prefix}-${code}`;
  // e.g., "WEL-7H2KQ9" or "BAM-X4F8N2"
}

export function generateTripAccessCodeWithRetry(
  portalSlug: string,
  existingCodes: Set<string>,
  maxRetries = 10
): string {
  for (let i = 0; i < maxRetries; i++) {
    const code = generateTripAccessCode(portalSlug);
    if (!existingCodes.has(code)) {
      return code;
    }
  }
  // Fallback: add timestamp suffix
  return `${generateTripAccessCode(portalSlug)}-${Date.now().toString(36).slice(-4).toUpperCase()}`;
}
```

## PHASE 7: Update Drizzle Schema (shared/schema.ts)

Add the new tables to the schema file:
```typescript
// Trip Itinerary Items (calendar events)
export const ccTripItineraryItems = pgTable('cc_trip_itinerary_items', {
  id: uuid('id').primaryKey().defaultRandom(),
  tripId: uuid('trip_id').notNull().references(() => ccTrips.id, { onDelete: 'cascade' }),
  
  itemType: varchar('item_type').notNull(),
  title: varchar('title').notNull(),
  description: text('description'),
  
  isBooked: boolean('is_booked').notNull().default(false),
  reservationId: uuid('reservation_id'),
  
  status: varchar('status').notNull().default('idea'),
  
  dayDate: date('day_date').notNull(),
  startTime: time('start_time'),
  endTime: time('end_time'),
  allDay: boolean('all_day').default(false),
  
  everyone: boolean('everyone').default(true),
  assignedParticipantIds: uuid('assigned_participant_ids').array(),
  
  locationName: varchar('location_name'),
  locationLat: numeric('location_lat', { precision: 10, scale: 7 }),
  locationLng: numeric('location_lng', { precision: 10, scale: 7 }),
  
  weatherSensitive: boolean('weather_sensitive').default(false),
  indoorAlternative: text('indoor_alternative'),
  
  photoMoment: boolean('photo_moment').default(false),
  suggestedCaption: text('suggested_caption'),
  
  externalUrl: text('external_url'),
  externalBookingRef: varchar('external_booking_ref'),
  
  icon: varchar('icon'),
  color: varchar('color'),
  sortOrder: integer('sort_order').default(0),
  
  createdBy: varchar('created_by'),
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
});

// Trip Timepoints (operational anchors)
export const ccTripTimepoints = pgTable('cc_trip_timepoints', {
  id: uuid('id').primaryKey().defaultRandom(),
  tripId: uuid('trip_id').notNull().references(() => ccTrips.id, { onDelete: 'cascade' }),
  
  kind: varchar('kind').notNull(),
  
  timeExact: timestamp('time_exact'),
  timeWindowStart: timestamp('time_window_start'),
  timeWindowEnd: timestamp('time_window_end'),
  timeConfidence: varchar('time_confidence').notNull().default('window'),
  
  locationName: varchar('location_name'),
  locationLat: numeric('location_lat', { precision: 10, scale: 7 }),
  locationLng: numeric('location_lng', { precision: 10, scale: 7 }),
  
  staffAction: text('staff_action'),
  staffAssignedTo: uuid('staff_assigned_to'),
  completedAt: timestamp('completed_at'),
  completedBy: uuid('completed_by'),
  
  guestNotes: text('guest_notes'),
  internalNotes: text('internal_notes'),
  
  itineraryItemId: uuid('itinerary_item_id').references(() => ccTripItineraryItems.id, { onDelete: 'set null' }),
  
  createdAt: timestamp('created_at').notNull().defaultNow(),
  updatedAt: timestamp('updated_at').notNull().defaultNow(),
});

// Portal Moments (curated suggestions)
export const ccPortalMoments = pgTable('cc_portal_moments', {
  id: uuid('id').primaryKey().defaultRandom(),
  portalId: uuid('portal_id').notNull(),
  
  title: varchar('title').notNull(),
  description: text('description'),
  momentType: varchar('moment_type').notNull(),
  
  bestTimeOfDay: varchar('best_time_of_day'),
  bestWeather: varchar('best_weather'),
  
  locationName: varchar('location_name'),
  locationLat: numeric('location_lat', { precision: 10, scale: 7 }),
  locationLng: numeric('location_lng', { precision: 10, scale: 7 }),
  
  kidFriendly: boolean('kid_friendly').default(true),
  
  proTip: text('pro_tip'),
  safetyNote: text('safety_note'),
  
  photoMoment: boolean('photo_moment').default(true),
  suggestedCaption: text('suggested_caption'),
  
  imageUrl: text('image_url'),
  icon: varchar('icon'),
  sortOrder: integer('sort_order').default(0),
  isActive: boolean('is_active').default(true),
  
  createdAt: timestamp('created_at').notNull().defaultNow(),
});
```

Also update the `ccTrips` table definition to include new columns:
```typescript
export const ccTrips = pgTable('cc_trips', {
  // ... existing columns ...
  
  // Add these new columns:
  portalId: uuid('portal_id'),
  tenantId: uuid('tenant_id'),
  accessCode: varchar('access_code').unique(),
  
  primaryContactName: varchar('primary_contact_name'),
  primaryContactEmail: varchar('primary_contact_email'),
  primaryContactPhone: varchar('primary_contact_phone'),
  
  originName: varchar('origin_name'),
  originType: varchar('origin_type'),
  originLat: numeric('origin_lat', { precision: 10, scale: 7 }),
  originLng: numeric('origin_lng', { precision: 10, scale: 7 }),
  
  hasVehicle: boolean('has_vehicle').default(true),
  hasTrailer: boolean('has_trailer').default(false),
  trailerType: varchar('trailer_type'),
  boatLengthFt: integer('boat_length_ft'),
  trailerLengthFt: integer('trailer_length_ft'),
  
  nextDestinationName: varchar('next_destination_name'),
  nextDestinationLat: numeric('next_destination_lat', { precision: 10, scale: 7 }),
  nextDestinationLng: numeric('next_destination_lng', { precision: 10, scale: 7 }),
  nextDestinationEmail: varchar('next_destination_email'),
  nextDestinationPhone: varchar('next_destination_phone'),
  coordinateHandoff: boolean('coordinate_handoff').default(false),
  
  currentAlertLevel: varchar('current_alert_level'),
  lastConditionsCheck: timestamp('last_conditions_check'),
});
```

## PHASE 8: Verify Everything
```sql
-- Confirm new columns on cc_trips
SELECT column_name, data_type 
FROM information_schema.columns 
WHERE table_name = 'cc_trips' 
AND column_name IN ('access_code', 'origin_name', 'has_trailer', 'boat_length_ft', 'coordinate_handoff')
ORDER BY column_name;

-- Confirm new tables exist
SELECT tablename FROM pg_tables 
WHERE schemaname = 'public' 
AND tablename IN ('cc_trip_itinerary_items', 'cc_trip_timepoints', 'cc_portal_moments')
ORDER BY tablename;

-- Confirm Bamfield moments seeded
SELECT COUNT(*) as moment_count FROM cc_portal_moments;

-- Show sample moments
SELECT title, moment_type, kid_friendly, icon FROM cc_portal_moments LIMIT 5;
```

## EVIDENCE REQUIRED

1. **SQL:** Show new columns on cc_trips
2. **SQL:** Show 3 new tables created
3. **SQL:** Show Bamfield moments count (should be 13+)
4. **Code:** Show accessCode.ts created
5. **Code:** Show schema.ts updated with new table definitions
6. **Build:** Clean build with no TypeScript errors