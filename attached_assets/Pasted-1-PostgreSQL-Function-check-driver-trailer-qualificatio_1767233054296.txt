1. PostgreSQL Function: check_driver_trailer_qualification
This is the core logic that determines if a driver can legally and safely tow a specific trailer.
sql-- Migration: Add check_driver_trailer_qualification function
-- File: server/db/migrations/011_driver_qualification_function.sql

-- First, create a composite type for the return value
DROP TYPE IF EXISTS qualification_result CASCADE;
CREATE TYPE qualification_result AS (
    is_qualified BOOLEAN,
    issues TEXT[],
    warnings TEXT[],
    required_endorsements TEXT[]
);

-- Main qualification checking function
CREATE OR REPLACE FUNCTION check_driver_trailer_qualification(
    p_driver_id UUID,
    p_trailer_id UUID,
    p_province VARCHAR(20) DEFAULT 'BC'
)
RETURNS qualification_result AS $$
DECLARE
    v_result qualification_result;
    v_driver RECORD;
    v_trailer RECORD;
    v_trailer_weight_kg NUMERIC;
    v_is_rv_trailer BOOLEAN;
    v_requires_air_brake BOOLEAN;
    v_days_until_license_expiry INTEGER;
    v_days_until_medical_expiry INTEGER;
BEGIN
    -- Initialize result
    v_result.is_qualified := TRUE;
    v_result.issues := ARRAY[]::TEXT[];
    v_result.warnings := ARRAY[]::TEXT[];
    v_result.required_endorsements := ARRAY[]::TEXT[];

    -- Fetch driver data
    SELECT 
        license_class,
        license_province,
        license_expiry,
        has_air_brake_endorsement,
        has_house_trailer_endorsement,
        has_heavy_trailer_endorsement,
        heavy_trailer_medical_expiry,
        max_trailer_weight_certified_kg,
        fifth_wheel_experience,
        gooseneck_experience,
        horse_trailer_experience,
        boat_launching_experience,
        full_name
    INTO v_driver
    FROM participant_profiles
    WHERE id = p_driver_id;

    IF NOT FOUND THEN
        v_result.is_qualified := FALSE;
        v_result.issues := array_append(v_result.issues, 'Driver profile not found');
        RETURN v_result;
    END IF;

    -- Fetch trailer data
    SELECT 
        trailer_type,
        gvwr_lbs,
        required_hitch_type,
        brake_type,
        nickname,
        length_feet
    INTO v_trailer
    FROM trailer_profiles
    WHERE id = p_trailer_id;

    IF NOT FOUND THEN
        v_result.is_qualified := FALSE;
        v_result.issues := array_append(v_result.issues, 'Trailer profile not found');
        RETURN v_result;
    END IF;

    -- Convert trailer weight to kg (1 lb = 0.453592 kg)
    v_trailer_weight_kg := COALESCE(v_trailer.gvwr_lbs, 0) * 0.453592;

    -- Determine if this is an RV-type trailer (for Code 07 vs Code 20)
    v_is_rv_trailer := v_trailer.trailer_type IN (
        'rv_travel_trailer', 'rv_fifth_wheel', 'rv_toy_hauler', 
        'rv_popup', 'rv_teardrop', 'park_model_rv',
        'tiny_home_thow'
    );

    -- Check if trailer has air brakes
    v_requires_air_brake := v_trailer.brake_type = 'air';

    -- ============================================
    -- CHECK 1: License Class Validity
    -- ============================================
    IF v_driver.license_class IS NULL THEN
        v_result.is_qualified := FALSE;
        v_result.issues := array_append(v_result.issues, 'No driver license class on file');
    ELSIF v_driver.license_class IN ('L', 'N') THEN
        -- Learner or Novice - restrictions apply
        v_result.warnings := array_append(v_result.warnings, 
            'Learner/Novice license - towing restrictions may apply. Check ICBC guidelines.');
    END IF;

    -- ============================================
    -- CHECK 2: License Expiry
    -- ============================================
    IF v_driver.license_expiry IS NOT NULL THEN
        v_days_until_license_expiry := v_driver.license_expiry - CURRENT_DATE;
        
        IF v_days_until_license_expiry < 0 THEN
            v_result.is_qualified := FALSE;
            v_result.issues := array_append(v_result.issues, 
                'Driver license EXPIRED on ' || to_char(v_driver.license_expiry, 'Mon DD, YYYY'));
        ELSIF v_days_until_license_expiry < 30 THEN
            v_result.warnings := array_append(v_result.warnings, 
                'Driver license expires in ' || v_days_until_license_expiry || ' days');
        END IF;
    ELSE
        v_result.warnings := array_append(v_result.warnings, 'No license expiry date on file');
    END IF;

    -- ============================================
    -- CHECK 3: BC Weight Thresholds (4,600 kg)
    -- ============================================
    IF p_province = 'BC' AND v_trailer_weight_kg > 4600 THEN
        IF v_is_rv_trailer THEN
            -- RV trailers > 4,600 kg require Code 07 (House Trailer Endorsement)
            IF NOT COALESCE(v_driver.has_house_trailer_endorsement, FALSE) THEN
                v_result.is_qualified := FALSE;
                v_result.issues := array_append(v_result.issues, 
                    'Trailer exceeds 4,600 kg (' || ROUND(v_trailer_weight_kg) || ' kg). BC Code 07 House Trailer Endorsement required.');
                v_result.required_endorsements := array_append(v_result.required_endorsements, 'BC Code 07 - House Trailer');
            END IF;
        ELSE
            -- Non-RV trailers > 4,600 kg require Code 20 (Heavy Trailer Endorsement)
            IF NOT COALESCE(v_driver.has_heavy_trailer_endorsement, FALSE) THEN
                v_result.is_qualified := FALSE;
                v_result.issues := array_append(v_result.issues, 
                    'Trailer exceeds 4,600 kg (' || ROUND(v_trailer_weight_kg) || ' kg). BC Code 20 Heavy Trailer Endorsement required.');
                v_result.required_endorsements := array_append(v_result.required_endorsements, 'BC Code 20 - Heavy Trailer');
            ELSE
                -- Has Code 20 - check medical expiry (required every 3 years)
                IF v_driver.heavy_trailer_medical_expiry IS NOT NULL THEN
                    v_days_until_medical_expiry := v_driver.heavy_trailer_medical_expiry - CURRENT_DATE;
                    
                    IF v_days_until_medical_expiry < 0 THEN
                        v_result.is_qualified := FALSE;
                        v_result.issues := array_append(v_result.issues, 
                            'Heavy trailer medical EXPIRED on ' || to_char(v_driver.heavy_trailer_medical_expiry, 'Mon DD, YYYY'));
                    ELSIF v_days_until_medical_expiry < 60 THEN
                        v_result.warnings := array_append(v_result.warnings, 
                            'Heavy trailer medical expires in ' || v_days_until_medical_expiry || ' days');
                    END IF;
                ELSE
                    v_result.warnings := array_append(v_result.warnings, 
                        'No heavy trailer medical expiry date on file');
                END IF;
            END IF;
        END IF;
    END IF;

    -- ============================================
    -- CHECK 4: Air Brake Endorsement
    -- ============================================
    IF v_requires_air_brake THEN
        IF NOT COALESCE(v_driver.has_air_brake_endorsement, FALSE) THEN
            v_result.is_qualified := FALSE;
            v_result.issues := array_append(v_result.issues, 
                'Trailer has air brakes. Air Brake Endorsement required.');
            v_result.required_endorsements := array_append(v_result.required_endorsements, 'Air Brake Endorsement');
        END IF;
        
        -- Air brakes + over 4,600 kg = Class 1 required
        IF v_trailer_weight_kg > 4600 AND v_driver.license_class NOT IN ('1', '2', '3') THEN
            v_result.is_qualified := FALSE;
            v_result.issues := array_append(v_result.issues, 
                'Air brakes + over 4,600 kg requires Class 1 Commercial License');
            v_result.required_endorsements := array_append(v_result.required_endorsements, 'Class 1 Commercial License');
        END IF;
    END IF;

    -- ============================================
    -- CHECK 5: Hitch Type Experience (Warnings)
    -- ============================================
    IF v_trailer.required_hitch_type = 'fifth_wheel' THEN
        IF NOT COALESCE(v_driver.fifth_wheel_experience, FALSE) THEN
            v_result.warnings := array_append(v_result.warnings, 
                'Driver has no fifth wheel experience on file. Consider supervised practice.');
        END IF;
    END IF;

    IF v_trailer.required_hitch_type = 'gooseneck' THEN
        IF NOT COALESCE(v_driver.gooseneck_experience, FALSE) THEN
            v_result.warnings := array_append(v_result.warnings, 
                'Driver has no gooseneck experience on file. Consider supervised practice.');
        END IF;
    END IF;

    -- ============================================
    -- CHECK 6: Special Trailer Types (Warnings)
    -- ============================================
    IF v_trailer.trailer_type LIKE 'horse_%' THEN
        IF NOT COALESCE(v_driver.horse_trailer_experience, FALSE) THEN
            v_result.warnings := array_append(v_result.warnings, 
                'Driver has no horse trailer experience. Live cargo requires special handling skills.');
        END IF;
    END IF;

    IF v_trailer.trailer_type = 'boat' THEN
        IF NOT COALESCE(v_driver.boat_launching_experience, FALSE) THEN
            v_result.warnings := array_append(v_result.warnings, 
                'Driver has no boat launching experience. Ramp backing requires practice.');
        END IF;
    END IF;

    -- ============================================
    -- CHECK 7: Trailer Length (BC max 12.5m / 41 ft)
    -- ============================================
    IF p_province = 'BC' AND COALESCE(v_trailer.length_feet, 0) > 41 THEN
        v_result.is_qualified := FALSE;
        v_result.issues := array_append(v_result.issues, 
            'Trailer length (' || v_trailer.length_feet || ' ft) exceeds BC maximum of 41 ft (12.5m)');
    END IF;

    RETURN v_result;
END;
$$ LANGUAGE plpgsql;

-- Grant execute permission
GRANT EXECUTE ON FUNCTION check_driver_trailer_qualification(UUID, UUID, VARCHAR) TO PUBLIC;

-- ============================================
-- HELPER FUNCTION: Get all qualification issues for a driver
-- ============================================
CREATE OR REPLACE FUNCTION get_driver_qualification_summary(p_driver_id UUID)
RETURNS TABLE (
    trailer_id UUID,
    trailer_nickname VARCHAR,
    trailer_type VARCHAR,
    is_qualified BOOLEAN,
    issue_count INTEGER,
    warning_count INTEGER,
    primary_issue TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT 
        t.id AS trailer_id,
        t.nickname AS trailer_nickname,
        t.trailer_type::VARCHAR,
        (check_driver_trailer_qualification(p_driver_id, t.id, 'BC')).is_qualified,
        array_length((check_driver_trailer_qualification(p_driver_id, t.id, 'BC')).issues, 1),
        array_length((check_driver_trailer_qualification(p_driver_id, t.id, 'BC')).warnings, 1),
        (check_driver_trailer_qualification(p_driver_id, t.id, 'BC')).issues[1]
    FROM trailer_profiles t
    WHERE t.user_id = (SELECT user_id FROM participant_profiles WHERE id = p_driver_id)
    ORDER BY t.nickname;
END;
$$ LANGUAGE plpgsql;

2. API Endpoint: Express Route
Add this to your server/routes/fleet.ts (or create a new file server/routes/qualifications.ts):
typescript// ============================================
// DRIVER QUALIFICATION CHECKING ENDPOINTS
// Add to server/routes/fleet.ts or create server/routes/qualifications.ts
// ============================================

import { Router } from 'express';
import { db } from '../db';
import { sql } from 'drizzle-orm';

const router = Router();

// Types for qualification results
interface QualificationResult {
  isQualified: boolean;
  issues: string[];
  warnings: string[];
  requiredEndorsements: string[];
}

interface DriverTrailerQualificationResponse {
  driverId: string;
  driverName: string;
  trailerId: string;
  trailerName: string;
  trailerType: string;
  province: string;
  qualification: QualificationResult;
  checkedAt: string;
}

// ============================================
// POST /api/fleet/check-qualification
// Check if a specific driver can tow a specific trailer
// ============================================
router.post('/check-qualification', async (req, res) => {
  try {
    const { driverId, trailerId, province = 'BC' } = req.body;

    if (!driverId || !trailerId) {
      return res.status(400).json({ 
        error: 'Missing required fields: driverId and trailerId' 
      });
    }

    // Call the PostgreSQL function
    const result = await db.execute(sql`
      SELECT 
        (check_driver_trailer_qualification(
          ${driverId}::uuid, 
          ${trailerId}::uuid, 
          ${province}
        )).*
    `);

    if (!result.rows || result.rows.length === 0) {
      return res.status(404).json({ error: 'Qualification check failed' });
    }

    const row = result.rows[0] as any;

    // Get driver and trailer names for the response
    const driverResult = await db.execute(sql`
      SELECT full_name FROM participant_profiles WHERE id = ${driverId}::uuid
    `);
    const trailerResult = await db.execute(sql`
      SELECT nickname, trailer_type FROM trailer_profiles WHERE id = ${trailerId}::uuid
    `);

    const response: DriverTrailerQualificationResponse = {
      driverId,
      driverName: driverResult.rows[0]?.full_name || 'Unknown Driver',
      trailerId,
      trailerName: trailerResult.rows[0]?.nickname || 'Unknown Trailer',
      trailerType: trailerResult.rows[0]?.trailer_type || 'unknown',
      province,
      qualification: {
        isQualified: row.is_qualified,
        issues: row.issues || [],
        warnings: row.warnings || [],
        requiredEndorsements: row.required_endorsements || []
      },
      checkedAt: new Date().toISOString()
    };

    res.json(response);
  } catch (error) {
    console.error('Qualification check error:', error);
    res.status(500).json({ error: 'Failed to check qualification' });
  }
});

// ============================================
// GET /api/fleet/driver/:driverId/qualifications
// Get qualification summary for all trailers a driver could tow
// ============================================
router.get('/driver/:driverId/qualifications', async (req, res) => {
  try {
    const { driverId } = req.params;

    // Get driver info
    const driverResult = await db.execute(sql`
      SELECT 
        id, full_name, license_class, license_province, license_expiry,
        has_air_brake_endorsement, has_house_trailer_endorsement,
        has_heavy_trailer_endorsement, heavy_trailer_medical_expiry,
        fifth_wheel_experience, gooseneck_experience,
        horse_trailer_experience, boat_launching_experience
      FROM participant_profiles 
      WHERE id = ${driverId}::uuid
    `);

    if (!driverResult.rows || driverResult.rows.length === 0) {
      return res.status(404).json({ error: 'Driver not found' });
    }

    const driver = driverResult.rows[0] as any;

    // Get qualification status for each trailer
    const qualificationsResult = await db.execute(sql`
      SELECT * FROM get_driver_qualification_summary(${driverId}::uuid)
    `);

    // Calculate summary stats
    const trailers = qualificationsResult.rows as any[];
    const qualifiedCount = trailers.filter(t => t.is_qualified).length;
    const totalTrailers = trailers.length;

    res.json({
      driver: {
        id: driver.id,
        name: driver.full_name,
        licenseClass: driver.license_class,
        licenseProvince: driver.license_province,
        licenseExpiry: driver.license_expiry,
        endorsements: {
          airBrake: driver.has_air_brake_endorsement || false,
          houseTrailer: driver.has_house_trailer_endorsement || false,
          heavyTrailer: driver.has_heavy_trailer_endorsement || false
        },
        medicalExpiry: driver.heavy_trailer_medical_expiry,
        experience: {
          fifthWheel: driver.fifth_wheel_experience || false,
          gooseneck: driver.gooseneck_experience || false,
          horseTrailer: driver.horse_trailer_experience || false,
          boatLaunching: driver.boat_launching_experience || false
        }
      },
      summary: {
        qualifiedFor: qualifiedCount,
        totalTrailers: totalTrailers,
        percentageQualified: totalTrailers > 0 
          ? Math.round((qualifiedCount / totalTrailers) * 100) 
          : 0
      },
      trailerQualifications: trailers.map(t => ({
        trailerId: t.trailer_id,
        trailerName: t.trailer_nickname,
        trailerType: t.trailer_type,
        isQualified: t.is_qualified,
        issueCount: t.issue_count || 0,
        warningCount: t.warning_count || 0,
        primaryIssue: t.primary_issue || null
      }))
    });
  } catch (error) {
    console.error('Driver qualifications error:', error);
    res.status(500).json({ error: 'Failed to get driver qualifications' });
  }
});

// ============================================
// GET /api/fleet/trailer/:trailerId/qualified-drivers
// Get all drivers qualified to tow a specific trailer
// ============================================
router.get('/trailer/:trailerId/qualified-drivers', async (req, res) => {
  try {
    const { trailerId } = req.params;

    // Get trailer info
    const trailerResult = await db.execute(sql`
      SELECT id, nickname, trailer_type, gvwr_lbs, required_hitch_type, brake_type
      FROM trailer_profiles 
      WHERE id = ${trailerId}::uuid
    `);

    if (!trailerResult.rows || trailerResult.rows.length === 0) {
      return res.status(404).json({ error: 'Trailer not found' });
    }

    const trailer = trailerResult.rows[0] as any;

    // Get all drivers and check qualification for each
    const driversResult = await db.execute(sql`
      SELECT 
        p.id,
        p.full_name,
        p.license_class,
        (check_driver_trailer_qualification(p.id, ${trailerId}::uuid, 'BC')).*
      FROM participant_profiles p
      WHERE p.role IN ('driver', 'coordinator')
      ORDER BY p.full_name
    `);

    const drivers = driversResult.rows as any[];
    const qualifiedDrivers = drivers.filter(d => d.is_qualified);

    res.json({
      trailer: {
        id: trailer.id,
        name: trailer.nickname,
        type: trailer.trailer_type,
        gvwrLbs: trailer.gvwr_lbs,
        hitchType: trailer.required_hitch_type,
        brakeType: trailer.brake_type
      },
      summary: {
        qualifiedDrivers: qualifiedDrivers.length,
        totalDrivers: drivers.length
      },
      drivers: drivers.map(d => ({
        id: d.id,
        name: d.full_name,
        licenseClass: d.license_class,
        isQualified: d.is_qualified,
        issues: d.issues || [],
        warnings: d.warnings || []
      }))
    });
  } catch (error) {
    console.error('Qualified drivers error:', error);
    res.status(500).json({ error: 'Failed to get qualified drivers' });
  }
});

export default router;
```

---

## 3. How to Apply This

**Step 1: Run the SQL Migration**
In Replit, go to your database console (or use a tool) and run the SQL from section 1. This creates:
- The `qualification_result` type
- The `check_driver_trailer_qualification()` function
- The `get_driver_qualification_summary()` helper function

**Step 2: Add the API Routes**
Either:
- Add the routes to your existing `server/routes/fleet.ts`
- Or create a new `server/routes/qualifications.ts` and import it in your main server file

**Step 3: Test It**
Once you have a driver profile with license info, you can call:
```
POST /api/fleet/check-qualification
{
  "driverId": "uuid-here",
  "trailerId": "uuid-here",
  "province": "BC"
}