Fix QA Batch 1 issues: test data cleanup and pricing gaps.

## Step 1: Remove duplicate/test properties

-- Find and review test properties
SELECT id, name, region, created_at 
FROM staging_properties 
WHERE name ILIKE '%test%' OR name ILIKE '%qa%';

-- Delete test properties and their related data
DELETE FROM staging_trip_stops WHERE property_id IN (
    SELECT id FROM staging_properties WHERE name ILIKE '%test%' OR name ILIKE '%qa%'
);

DELETE FROM staging_service_providers WHERE property_id IN (
    SELECT id FROM staging_properties WHERE name ILIKE '%test%' OR name ILIKE '%qa%'
);

DELETE FROM staging_pricing WHERE property_id IN (
    SELECT id FROM staging_properties WHERE name ILIKE '%test%' OR name ILIKE '%qa%'
);

DELETE FROM staging_bookings WHERE property_id IN (
    SELECT id FROM staging_properties WHERE name ILIKE '%test%' OR name ILIKE '%qa%'
);

DELETE FROM staging_properties WHERE name ILIKE '%test%' OR name ILIKE '%qa%';

-- Verify cleanup
SELECT COUNT(*) as remaining_test_properties 
FROM staging_properties 
WHERE name ILIKE '%test%' OR name ILIKE '%qa%';
-- EXPECTED: 0

## Step 2: Mark truck stop $0 pricing as intentional

-- Update truck stop pricing to have a note that it's free with fuel
-- Also add a small overnight fee for those without fuel purchase

UPDATE staging_pricing 
SET notes = 'Free overnight parking with fuel purchase'
WHERE property_id IN (
    SELECT id FROM staging_properties 
    WHERE property_subtype = 'truck_stop'
) AND nightly_rate = 0;

-- Verify
SELECT sp.name, pr.nightly_rate, pr.notes
FROM staging_properties sp
JOIN staging_pricing pr ON pr.property_id = sp.id
WHERE sp.property_subtype = 'truck_stop';

## Step 3: Find any remaining properties without pricing and add default

-- Check for properties still missing pricing
SELECT id, name, property_type, property_subtype
FROM staging_properties
WHERE id NOT IN (SELECT property_id FROM staging_pricing WHERE pricing_type = 'base_nightly')
AND status = 'active';

-- If any found, add default pricing based on type
INSERT INTO staging_pricing (property_id, pricing_type, nightly_rate, is_active)
SELECT 
    sp.id,
    'base_nightly',
    CASE 
        WHEN sp.property_subtype = 'truck_stop' THEN 0.00
        WHEN sp.property_type = 'rv_park' THEN 50.00
        WHEN sp.property_type = 'campground' THEN 40.00
        ELSE 45.00
    END,
    true
FROM staging_properties sp
WHERE sp.id NOT IN (SELECT property_id FROM staging_pricing WHERE pricing_type = 'base_nightly')
AND sp.status = 'active';

## Step 4: Verify fixes

-- Rerun batch 1 checks
SELECT 'Test 3 - Properties without pricing' as test,
    CASE WHEN COUNT(*) = 0 THEN 'PASS' ELSE 'FAIL: ' || COUNT(*) END as result
FROM staging_properties sp
LEFT JOIN staging_pricing pr ON pr.property_id = sp.id AND pr.pricing_type = 'base_nightly'
WHERE pr.id IS NULL AND sp.status = 'active';

SELECT 'Test 6 - Duplicate properties' as test,
    CASE WHEN COUNT(*) = 0 THEN 'PASS' ELSE 'FAIL' END as result
FROM (
    SELECT name, region, COUNT(*) 
    FROM staging_properties 
    GROUP BY name, region 
    HAVING COUNT(*) > 1
) dupes;

SELECT 'Test 9 - Pricing sanity' as test,
    CASE WHEN COUNT(*) = 0 THEN 'PASS (truck stops excluded)' ELSE 'FAIL' END as result
FROM staging_properties sp
JOIN staging_pricing pr ON pr.property_id = sp.id AND pr.pricing_type = 'base_nightly'
WHERE (pr.nightly_rate < 0 OR pr.nightly_rate > 500)
AND sp.property_subtype != 'truck_stop';

Report updated test results.