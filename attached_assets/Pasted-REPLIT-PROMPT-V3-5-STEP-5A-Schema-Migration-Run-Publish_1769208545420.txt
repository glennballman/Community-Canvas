REPLIT PROMPT — V3.5 STEP 5A — Schema Migration (Run Publishing Foundation)

ROLE: Senior Platform Engineer adding foundational schema for run publishing.
MODE: Schema-only. No routes. No UI. No behavior changes.

============================================================
HARD RULES
============================================================
- This is SCHEMA ONLY — do not touch routes, UI, or business logic
- Follow existing migration numbering convention
- Use existing RLS patterns from other cc_* tables
- Do not create indexes that duplicate existing ones
- Do not modify any existing columns or tables beyond the additions specified

============================================================
GOAL
============================================================
Add two schema elements required for STEP 5 (Run Publishing):
1. market_mode column on cc_n3_runs
2. cc_run_portal_publications join table

============================================================
STEP 1: FIND MIGRATION NUMBERING
============================================================
- List existing migrations to find the next number
- Use the same file naming pattern (e.g., 172_run_publishing_schema.sql)

============================================================
STEP 2: CREATE MIGRATION FILE
============================================================

Create migration with the following SQL:

------------------------------------------------------------
-- V3.5 STEP 5A: Run Publishing Schema
-- Adds market_mode column and multi-portal publication support
------------------------------------------------------------

-- 1) Add market_mode to cc_n3_runs
-- Controls WHO can attach requests to this run (competition, not visibility)
-- Allowed values: OPEN, INVITE_ONLY, CLOSED
-- TARGETED is demand-side only and MUST NOT be used here

ALTER TABLE cc_n3_runs 
ADD COLUMN IF NOT EXISTS market_mode TEXT DEFAULT 'INVITE_ONLY';

-- Add CHECK constraint for allowed values
ALTER TABLE cc_n3_runs
ADD CONSTRAINT cc_n3_runs_market_mode_check 
CHECK (market_mode IN ('OPEN', 'INVITE_ONLY', 'CLOSED'));

COMMENT ON COLUMN cc_n3_runs.market_mode IS 
'Controls who can attach requests. OPEN=any eligible, INVITE_ONLY=invited only, CLOSED=no new attachments. TARGETED is not valid for runs (supply-side). See docs/TERMINOLOGY_CANON.md';

-- 2) Create multi-portal publication join table
-- Controls WHERE the run is visible (visibility, not competition)

CREATE TABLE IF NOT EXISTS cc_run_portal_publications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  tenant_id UUID NOT NULL REFERENCES cc_tenants(id) ON DELETE CASCADE,
  run_id UUID NOT NULL REFERENCES cc_n3_runs(id) ON DELETE CASCADE,
  portal_id UUID NOT NULL REFERENCES cc_portals(id) ON DELETE CASCADE,
  published_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  published_by_party_id UUID REFERENCES cc_parties(id),
  unpublished_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  UNIQUE(tenant_id, run_id, portal_id)
);

COMMENT ON TABLE cc_run_portal_publications IS 
'Join table for run visibility across multiple portals. Publishing ≠ commitment ≠ attachment. See docs/TERMINOLOGY_CANON.md';

-- 3) Indexes for efficient queries
CREATE INDEX IF NOT EXISTS idx_run_portal_publications_run_id 
ON cc_run_portal_publications(run_id);

CREATE INDEX IF NOT EXISTS idx_run_portal_publications_portal_id 
ON cc_run_portal_publications(portal_id);

CREATE INDEX IF NOT EXISTS idx_run_portal_publications_tenant_id 
ON cc_run_portal_publications(tenant_id);

CREATE INDEX IF NOT EXISTS idx_run_portal_publications_active
ON cc_run_portal_publications(run_id, portal_id) 
WHERE unpublished_at IS NULL;

-- 4) Enable RLS (match existing cc_* table patterns)
ALTER TABLE cc_run_portal_publications ENABLE ROW LEVEL SECURITY;

-- Tenant isolation policy
CREATE POLICY cc_run_portal_publications_tenant_isolation 
ON cc_run_portal_publications
FOR ALL
USING (tenant_id::text = current_setting('app.tenant_id', true));

-- Service bypass policy
CREATE POLICY cc_run_portal_publications_service_bypass 
ON cc_run_portal_publications
FOR ALL
USING (current_setting('app.tenant_id', true) = '__SERVICE__');

============================================================
STEP 3: RUN MIGRATION
============================================================
- Execute the migration
- Verify no errors

============================================================
STEP 4: VERIFICATION (REQUIRED)
============================================================

Run these queries and paste results:

-- Verify market_mode column exists
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'cc_n3_runs' AND column_name = 'market_mode';

-- Verify CHECK constraint exists
SELECT constraint_name, check_clause 
FROM information_schema.check_constraints 
WHERE constraint_name = 'cc_n3_runs_market_mode_check';

-- Verify join table exists
SELECT column_name, data_type, is_nullable
FROM information_schema.columns 
WHERE table_name = 'cc_run_portal_publications'
ORDER BY ordinal_position;

-- Verify RLS is enabled
SELECT tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'cc_run_portal_publications';

-- Verify indexes exist
SELECT indexname FROM pg_indexes 
WHERE tablename = 'cc_run_portal_publications';

============================================================
STEP 5: UPDATE PROOF DOCUMENT
============================================================

Update: proof/v3.5/run-publishing-audit.md

Add section "Schema Additions (STEP 5A)" with:
- Migration file name
- SQL executed
- Verification query results
- Confirmation that:
  - [ ] market_mode column exists with CHECK constraint
  - [ ] cc_run_portal_publications table exists
  - [ ] RLS policies are active
  - [ ] Indexes are created
  - [ ] No other schema changes made

============================================================
STEP 6: SAVE TERMINOLOGY CANON
============================================================

Create file: docs/TERMINOLOGY_CANON.md

Content (paste exactly):

[I will provide the full TERMINOLOGY_CANON.md v2 content in the next message if needed]

============================================================
DO NOT DO
============================================================
- Do NOT add routes
- Do NOT add UI components
- Do NOT modify existing business logic
- Do NOT change cc_n3_runs.portal_id behavior (legacy, may still be used)
- Do NOT create additional tables or columns beyond what is specified

============================================================
OUTPUT
============================================================

When complete, report:
1. Migration file path
2. Verification query results
3. Confirmation that STEP 5A is complete
4. Ready for STEP 5B (implementation)

END.