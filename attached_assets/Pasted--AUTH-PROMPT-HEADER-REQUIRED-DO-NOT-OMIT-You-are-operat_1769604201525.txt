# AUTH PROMPT HEADER (REQUIRED — DO NOT OMIT)

You are operating under AUTH_CONSTITUTION.md (governance is law).
You MUST:

1) Be fail-closed. No fallbacks to legacy flags, JWT claims, or “best effort” auth.
2) Use Single Identity Authority: resolvePrincipalFromSession() and effective_principal_id.
3) Use capability-first authorization: requireCapability()/authorize()/cc_has_capability().
4) Log ALL allow + deny decisions to cc_auth_audit_log with principal_id + effective_principal_id.
5) Provide an Annex checklist with PASS/FAIL and EVIDENCE (file paths + line numbers) for every requirement in this prompt.
6) If anything is ambiguous, you MUST search the repo and cite exact file paths/lines—do not guess.
7) You may not reduce scope. No MVP. No “manual only”. No deferrals unless explicitly stated as an allowed deferral.

Before you claim “COMPLETE”, you MUST paste back:

- The Annex (PASS/FAIL + evidence)
- Test output (or explicit SKIP reasons tied to missing dependencies)
- Any migrations (full filenames)

## PROMPT-15: External Role Mapping Enforcement (Jobber + others) — No More SKIPs

### Problem

We have schemas and partial tests that were skipping pending dependencies. We must:

- enable mapping tests
- provide a deterministic mapping resolver that translates external role -> internal role_code -> capabilities
- ensure no route can accept “external role” input without mapping + validation

### Required Work

A) Turn SKIP tests into PASS:

- Unskip jobber-mapping tests.
- Ensure required tables exist and are populated (migrations already created in prior prompts; verify).

B) Implement mapping resolver:

- server/auth/externalMappings.ts
  - resolveExternalRoleToRoleCode(external_system, external_role_code) -> role_code (or deny)
  - must fail-closed on unknown systems/roles
  - must be auditable (log deny reasons when mapping missing)

C) Add an ingestion-safe API (platform.configure required):

- POST /api/platform/external-mappings/preview
  - input: external_system, external_role_code
  - output: mapped role_code + list of capabilities
  - deny if unmapped
- This is for QA and future ingest pipelines.

D) Ensure no “silent defaults”:

- If a role is unmapped, do NOT assign tenant_admin or any default.

E) Docs:

- docs/PROMPT-15-ANNEX.md with evidence and test output.

### Acceptance Criteria

- Mapping tests pass (no SKIPs)
- Resolver is fail-closed
- Preview endpoint is capability-guarded and audited
- Annex PASS/FAIL evidence